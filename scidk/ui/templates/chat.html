{% extends 'base.html' %}
{% block title %}-SciDK-> Chat{% endblock %}
{% block content %}
<section>
  <h2>üí¨ Chat <span class="badge" style="background:#4a90e2; color:#fff; font-size:0.6em; padding:0.2em 0.5em; border-radius:3px">GraphRAG</span></h2>
  <p class="small">Ask questions about your graph data in natural language.</p>

  <div style="margin-bottom: 1rem;">
    <label style="font-size: 0.9em;">
      <input type="checkbox" id="verbose-mode" />
      Show technical details (entities, execution time)
    </label>
  </div>

  <form id="chat-form">
    <textarea id="chat-input" style="width:100%; height: 5rem; font-family: inherit;" placeholder="Example: Find all files in my project&#10;Example: How many File nodes are in the database?&#10;Example: Show me recent scans" data-testid="chat-input"></textarea>
    <div class="actions">
      <button type="submit" data-testid="chat-send">Send</button>
      <button type="button" id="clear-history" style="background:#6c757d" data-testid="chat-clear">Clear History</button>
    </div>
  </form>

  <div id="chat-history" style="margin-top:1.5rem" data-testid="chat-history"></div>
</section>
{% endblock %}
{% block head %}
<style>
  .chat-message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 6px;
    background: #f8f9fa;
  }
  .chat-message.user {
    background: #e3f2fd;
    border-left: 3px solid #2196f3;
  }
  .chat-message.assistant {
    background: #f1f8e9;
    border-left: 3px solid #8bc34a;
  }
  .chat-message-role {
    font-weight: bold;
    font-size: 0.85em;
    margin-bottom: 0.5rem;
    color: #555;
  }
  .chat-message-content {
    white-space: pre-wrap;
    line-height: 1.5;
  }
  .chat-metadata {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #ddd;
    font-size: 0.85em;
    color: #666;
  }
  .entity-badge {
    display: inline-block;
    padding: 0.2em 0.5em;
    margin: 0.2em;
    border-radius: 3px;
    background: #e0e0e0;
    font-size: 0.85em;
  }
  .entity-badge.identifier { background: #ce93d8; color: #000; }
  .entity-badge.label { background: #81c784; color: #000; }
  .entity-badge.property { background: #64b5f6; color: #000; }
  .time-badge {
    display: inline-block;
    padding: 0.2em 0.5em;
    margin-left: 0.5em;
    border-radius: 3px;
    background: #fff3cd;
    color: #856404;
    font-size: 0.85em;
  }
</style>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const history = document.getElementById('chat-history');
    const verboseCheckbox = document.getElementById('verbose-mode');
    const clearBtn = document.getElementById('clear-history');

    // Load saved history and verbose preference
    loadHistory();
    verboseCheckbox.checked = localStorage.getItem('chat_verbose') === 'true';

    // Save verbose preference
    verboseCheckbox.addEventListener('change', () => {
      localStorage.setItem('chat_verbose', verboseCheckbox.checked);
    });

    // Clear history
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all chat history?')) {
        localStorage.removeItem('chat_messages');
        history.innerHTML = '<p class="small" style="color:#999">History cleared. Start a new conversation!</p>';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      // Add user message immediately
      appendMessage('user', message);
      input.value = '';

      try {
        const resp = await fetch('/api/chat/graphrag', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await resp.json();

        if (data.status === 'ok') {
          const metadata = data.metadata || null;
          appendMessage('assistant', data.reply, metadata);
        } else {
          appendMessage('assistant', `Error: ${data.error || 'Unknown error'}`, null);
        }
      } catch (err) {
        appendMessage('assistant', `Error: ${err.message}`, null);
      }
    });

    function appendMessage(role, content, metadata = null) {
      const messages = JSON.parse(localStorage.getItem('chat_messages') || '[]');
      const msg = { role, content, metadata, timestamp: Date.now() };
      messages.push(msg);
      localStorage.setItem('chat_messages', JSON.stringify(messages));
      renderHistory();
    }

    function loadHistory() {
      renderHistory();
    }

    function renderHistory() {
      const messages = JSON.parse(localStorage.getItem('chat_messages') || '[]');
      if (messages.length === 0) {
        history.innerHTML = '<p class="small" style="color:#999">No messages yet. Start a conversation!</p>';
        return;
      }

      const verbose = verboseCheckbox.checked;
      history.innerHTML = messages.map(msg => {
        let metadataHtml = '';
        if (verbose && msg.metadata && msg.role === 'assistant') {
          const entities = msg.metadata.entities || {};
          const executionTime = msg.metadata.execution_time_ms || 0;
          const resultCount = msg.metadata.result_count || 0;

          let entitiesHtml = '';
          if (entities.identifiers && entities.identifiers.length > 0) {
            entitiesHtml += entities.identifiers.map(id =>
              `<span class="entity-badge identifier">ID: ${id}</span>`
            ).join('');
          }
          if (entities.labels && entities.labels.length > 0) {
            entitiesHtml += entities.labels.map(label =>
              `<span class="entity-badge label">Label: ${label}</span>`
            ).join('');
          }
          if (entities.properties && Object.keys(entities.properties).length > 0) {
            entitiesHtml += Object.entries(entities.properties).map(([k, v]) =>
              `<span class="entity-badge property">${k}: ${v}</span>`
            ).join('');
          }

          if (entitiesHtml || executionTime > 0) {
            metadataHtml = `<div class="chat-metadata">
              ${entitiesHtml}
              ${executionTime > 0 ? `<span class="time-badge">‚è±Ô∏è ${executionTime}ms</span>` : ''}
              ${resultCount > 0 ? `<span class="time-badge">üìä ${resultCount} results</span>` : ''}
            </div>`;
          }
        }

        return `<div class="chat-message ${msg.role}" data-testid="chat-message-${msg.role}">
          <div class="chat-message-role">${msg.role === 'user' ? 'üë§ You' : 'ü§ñ Assistant'}</div>
          <div class="chat-message-content">${escapeHtml(msg.content)}</div>
          ${metadataHtml}
        </div>`;
      }).join('');

      // Scroll to bottom
      history.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  });
</script>
{% endblock %}
