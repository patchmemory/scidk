{% extends 'base.html' %}
{% block title %}SciDK - Links{% endblock %}
{% block content %}
<style>
  .links-container {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    height: calc(100vh - 200px);
  }
  .links-list {
    flex: 0 0 25%;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 0.5rem;
    overflow-y: auto;
  }
  .links-wizard {
    flex: 1;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 1rem;
    overflow-y: auto;
  }
  .link-item {
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid transparent;
  }
  .link-item:hover {
    background: #f3f3f3;
  }
  .link-item.active {
    background: #e3f2fd;
    border-color: #2196f3;
  }
  .wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    position: relative;
  }
  .wizard-steps::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 2px;
    background: #eee;
    z-index: 0;
  }
  .wizard-step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 1;
  }
  .wizard-step-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #eee;
    color: #999;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
  }
  .wizard-step.active .wizard-step-circle {
    background: #2196f3;
    color: white;
  }
  .wizard-step.completed .wizard-step-circle {
    background: #4caf50;
    color: white;
  }
  .wizard-step-label {
    font-size: 0.75rem;
    color: #666;
  }
  .wizard-step.active .wizard-step-label {
    color: #2196f3;
    font-weight: bold;
  }
  .wizard-content {
    min-height: 400px;
  }
  .wizard-step-content {
    display: none;
  }
  .wizard-step-content.active {
    display: block;
  }
  .wizard-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
  }
  .form-group {
    margin-bottom: 1rem;
  }
  .form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  .match-preview {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f8f8;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
  }
  .match-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 4px;
    border: 1px solid #eee;
    font-family: monospace;
    font-size: 0.85rem;
  }
  .empty-state {
    text-align: center;
    color: #999;
    padding: 2rem;
  }
  .property-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    align-items: center;
  }
  .property-row input {
    flex: 1;
  }
  .btn-sm-icon {
    padding: 0.25rem 0.5rem;
  }
</style>

<h1>Links</h1>
<p class="small">Create relationships between data instances using graph, CSV, or API sources.</p>

<div class="links-container">
  <!-- Left Panel: Link Definitions List -->
  <div class="links-list">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <h3 class="small" style="margin: 0;">Definitions</h3>
      <button id="btn-new-link" class="btn btn-sm btn-primary" data-testid="new-link-btn">New Link</button>
    </div>
    <div id="link-list" data-testid="link-list">
      <div class="empty-state small">No link definitions</div>
    </div>
  </div>

  <!-- Right Panel: Wizard -->
  <div class="links-wizard" id="link-wizard" style="display: none;">
    <h3 id="wizard-title">New Link Definition</h3>

    <!-- Wizard Steps Indicator -->
    <div class="wizard-steps">
      <div class="wizard-step active" data-step="1">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">Source</div>
      </div>
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">Target</div>
      </div>
      <div class="wizard-step" data-step="3">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">Relationship</div>
      </div>
      <div class="wizard-step" data-step="4">
        <div class="wizard-step-circle">4</div>
        <div class="wizard-step-label">Preview</div>
      </div>
    </div>

    <!-- Wizard Content -->
    <div class="wizard-content">
      <!-- Step 1: Configure Source -->
      <div id="step-1" class="wizard-step-content active">
        <h4>Configure Source</h4>

        <div class="form-group">
          <label class="form-label small" for="link-name">Link Name</label>
          <input id="link-name" type="text" class="form-control form-control-sm" placeholder="e.g., Authors to Files" data-testid="link-name" />
        </div>

        <div class="form-group">
          <label class="form-label small">Source Type</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-outline-primary source-type-btn active" data-source="graph">Graph</button>
            <button class="btn btn-sm btn-outline-primary source-type-btn" data-source="csv">CSV</button>
            <button class="btn btn-sm btn-outline-primary source-type-btn" data-source="api">API</button>
          </div>
        </div>

        <!-- Graph Source -->
        <div id="source-graph" class="source-config">
          <div class="form-group">
            <label class="form-label small" for="source-label">Label</label>
            <input id="source-label" type="text" class="form-control form-control-sm" placeholder="e.g., Person" />
          </div>
          <div class="form-group">
            <label class="form-label small" for="source-where">WHERE Clause (optional)</label>
            <input id="source-where" type="text" class="form-control form-control-sm" placeholder="e.g., p.role = 'author'" />
          </div>
        </div>

        <!-- CSV Source -->
        <div id="source-csv" class="source-config" style="display: none;">
          <div class="form-group">
            <label class="form-label small" for="csv-data">CSV Data</label>
            <textarea id="csv-data" class="form-control form-control-sm" rows="8" placeholder="name,email,file_path&#10;Alice,alice@ex.com,file1.txt&#10;Bob,bob@ex.com,file2.txt"></textarea>
            <small class="small text-muted">Paste CSV data with headers in first row</small>
          </div>
        </div>

        <!-- API Source -->
        <div id="source-api" class="source-config" style="display: none;">
          <div class="form-group">
            <label class="form-label small" for="api-url">API URL</label>
            <input id="api-url" type="text" class="form-control form-control-sm" placeholder="https://api.example.com/users" />
          </div>
          <div class="form-group">
            <label class="form-label small" for="api-jsonpath">JSONPath (optional)</label>
            <input id="api-jsonpath" type="text" class="form-control form-control-sm" placeholder="$.users[*]" />
          </div>
        </div>
      </div>

      <!-- Step 2: Configure Target -->
      <div id="step-2" class="wizard-step-content">
        <h4>Configure Target</h4>

        <div class="form-group">
          <label class="form-label small">Target Type</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-outline-primary target-type-btn active" data-target="label">Label</button>
            <button class="btn btn-sm btn-outline-primary target-type-btn" data-target="graph">Graph Query</button>
          </div>
        </div>

        <!-- Label Target -->
        <div id="target-label" class="target-config">
          <div class="form-group">
            <label class="form-label small" for="target-label-name">Label</label>
            <input id="target-label-name" type="text" class="form-control form-control-sm" placeholder="e.g., File" />
          </div>
        </div>

        <!-- Graph Target -->
        <div id="target-graph" class="target-config" style="display: none;">
          <div class="form-group">
            <label class="form-label small" for="target-graph-label">Label</label>
            <input id="target-graph-label" type="text" class="form-control form-control-sm" placeholder="e.g., Document" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label small">Match Strategy</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-outline-primary match-strategy-btn active" data-strategy="property">Property</button>
            <button class="btn btn-sm btn-outline-primary match-strategy-btn" data-strategy="id">ID</button>
            <button class="btn btn-sm btn-outline-primary match-strategy-btn" data-strategy="cypher">Cypher</button>
          </div>
        </div>

        <!-- Property Match -->
        <div id="match-property" class="match-config">
          <div class="form-group">
            <label class="form-label small" for="match-source-field">Source Field</label>
            <input id="match-source-field" type="text" class="form-control form-control-sm" placeholder="e.g., email" />
          </div>
          <div class="form-group">
            <label class="form-label small" for="match-target-field">Target Field</label>
            <input id="match-target-field" type="text" class="form-control form-control-sm" placeholder="e.g., author_email" />
          </div>
        </div>

        <!-- ID Match -->
        <div id="match-id" class="match-config" style="display: none;">
          <small class="small text-muted">Match by direct node ID (source must contain 'target_id' field)</small>
        </div>

        <!-- Cypher Match -->
        <div id="match-cypher" class="match-config" style="display: none;">
          <div class="form-group">
            <label class="form-label small" for="match-cypher-query">Cypher Match Clause</label>
            <textarea id="match-cypher-query" class="form-control form-control-sm" rows="4" placeholder="MATCH (t:Target) WHERE t.prop = $source_field"></textarea>
          </div>
        </div>
      </div>

      <!-- Step 3: Define Relationship -->
      <div id="step-3" class="wizard-step-content">
        <h4>Define Relationship</h4>

        <div class="form-group">
          <label class="form-label small" for="rel-type">Relationship Type</label>
          <input id="rel-type" type="text" class="form-control form-control-sm" placeholder="e.g., AUTHORED" />
        </div>

        <div class="form-group">
          <label class="form-label small">Properties (optional)</label>
          <div id="rel-props-container" data-testid="rel-props-container"></div>
          <button id="btn-add-rel-prop" class="btn btn-sm btn-outline-primary" style="margin-top: 0.5rem;">Add Property</button>
        </div>
      </div>

      <!-- Step 4: Preview & Execute -->
      <div id="step-4" class="wizard-step-content">
        <h4>Preview & Execute</h4>

        <div style="margin-bottom: 1rem;">
          <button id="btn-load-preview" class="btn btn-sm btn-primary" data-testid="load-preview-btn">Load Preview</button>
          <span id="preview-loading" style="margin-left: 0.5rem; display: none;">Loading...</span>
        </div>

        <div id="preview-container">
          <div class="empty-state small">Click "Load Preview" to see sample matches</div>
        </div>
      </div>
    </div>

    <!-- Wizard Navigation -->
    <div class="wizard-nav">
      <button id="btn-prev" class="btn btn-sm btn-outline-secondary" style="display: none;">← Back</button>
      <div style="display: flex; gap: 0.5rem;">
        <button id="btn-save-def" class="btn btn-sm btn-outline-success">Save Definition</button>
        <button id="btn-next" class="btn btn-sm btn-primary">Next →</button>
        <button id="btn-execute" class="btn btn-sm btn-success" style="display: none;" data-testid="execute-link-btn">Execute</button>
        <button id="btn-delete-def" class="btn btn-sm btn-outline-danger" style="display: none;">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
// State management
let currentLink = null;
let currentStep = 1;
let linkDefinitions = [];
let wizardData = {
  id: null,
  name: '',
  source_type: 'graph',
  source_config: {},
  target_type: 'label',
  target_config: {},
  match_strategy: 'property',
  match_config: {},
  relationship_type: '',
  relationship_props: {}
};

// Toast function
function showToast(message, type = 'info') {
  if (typeof window.toast === 'function') {
    window.toast(message, type, 3000);
  } else {
    console.log(`[${type}] ${message}`);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadLinkDefinitions();
  initializeEventListeners();
});

function initializeEventListeners() {
  // New link button
  document.getElementById('btn-new-link').addEventListener('click', () => {
    resetWizard();
    showWizard();
  });

  // Wizard navigation
  document.getElementById('btn-prev').addEventListener('click', () => navigateStep(-1));
  document.getElementById('btn-next').addEventListener('click', () => navigateStep(1));
  document.getElementById('btn-execute').addEventListener('click', executeLink);
  document.getElementById('btn-save-def').addEventListener('click', saveLinkDefinition);
  document.getElementById('btn-delete-def').addEventListener('click', deleteLinkDefinition);

  // Source type buttons
  document.querySelectorAll('.source-type-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.source-type-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      wizardData.source_type = e.target.dataset.source;
      showSourceConfig(wizardData.source_type);
    });
  });

  // Target type buttons
  document.querySelectorAll('.target-type-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.target-type-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      wizardData.target_type = e.target.dataset.target;
      showTargetConfig(wizardData.target_type);
    });
  });

  // Match strategy buttons
  document.querySelectorAll('.match-strategy-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.match-strategy-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      wizardData.match_strategy = e.target.dataset.strategy;
      showMatchConfig(wizardData.match_strategy);
    });
  });

  // Add relationship property button
  document.getElementById('btn-add-rel-prop').addEventListener('click', addRelationshipProperty);

  // Preview button
  document.getElementById('btn-load-preview').addEventListener('click', loadPreview);
}

function loadLinkDefinitions() {
  fetch('/api/links')
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        linkDefinitions = data.links || [];
        renderLinkList();
      }
    })
    .catch(err => showToast('Failed to load link definitions', 'error'));
}

function renderLinkList() {
  const container = document.getElementById('link-list');
  if (linkDefinitions.length === 0) {
    container.innerHTML = '<div class="empty-state small">No link definitions</div>';
    return;
  }

  container.innerHTML = linkDefinitions.map(link => `
    <div class="link-item" data-link-id="${link.id}" onclick="loadLinkDefinition('${link.id}')">
      <div style="font-weight: 500;">${link.name || 'Unnamed'}</div>
      <div class="small" style="color: #666;">
        ${link.source_type} → ${link.target_type} (${link.relationship_type})
      </div>
    </div>
  `).join('');
}

function loadLinkDefinition(linkId) {
  fetch(`/api/links/${linkId}`)
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        currentLink = data.link;
        populateWizardFromLink(currentLink);
        showWizard();
      }
    })
    .catch(err => showToast('Failed to load link definition', 'error'));
}

function populateWizardFromLink(link) {
  wizardData = {
    id: link.id,
    name: link.name,
    source_type: link.source_type,
    source_config: link.source_config || {},
    target_type: link.target_type,
    target_config: link.target_config || {},
    match_strategy: link.match_strategy,
    match_config: link.match_config || {},
    relationship_type: link.relationship_type,
    relationship_props: link.relationship_props || {}
  };

  // Populate Step 1
  document.getElementById('link-name').value = link.name || '';
  document.querySelectorAll('.source-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.source === link.source_type);
  });
  showSourceConfig(link.source_type);

  if (link.source_type === 'graph') {
    document.getElementById('source-label').value = link.source_config.label || '';
    document.getElementById('source-where').value = link.source_config.where_clause || '';
  } else if (link.source_type === 'csv') {
    document.getElementById('csv-data').value = link.source_config.csv_data || '';
  } else if (link.source_type === 'api') {
    document.getElementById('api-url').value = link.source_config.url || '';
    document.getElementById('api-jsonpath').value = link.source_config.json_path || '';
  }

  // Populate Step 2
  document.querySelectorAll('.target-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.target === link.target_type);
  });
  showTargetConfig(link.target_type);

  if (link.target_type === 'label') {
    document.getElementById('target-label-name').value = link.target_config.label || '';
  } else if (link.target_type === 'graph') {
    document.getElementById('target-graph-label').value = link.target_config.label || '';
  }

  document.querySelectorAll('.match-strategy-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.strategy === link.match_strategy);
  });
  showMatchConfig(link.match_strategy);

  if (link.match_strategy === 'property') {
    document.getElementById('match-source-field').value = link.match_config.source_field || '';
    document.getElementById('match-target-field').value = link.match_config.target_field || '';
  } else if (link.match_strategy === 'cypher') {
    document.getElementById('match-cypher-query').value = link.match_config.cypher || '';
  }

  // Populate Step 3
  document.getElementById('rel-type').value = link.relationship_type || '';
  renderRelationshipProps();

  // Show delete button
  document.getElementById('btn-delete-def').style.display = 'inline-block';
}

function resetWizard() {
  currentLink = null;
  currentStep = 1;
  wizardData = {
    id: null,
    name: '',
    source_type: 'graph',
    source_config: {},
    target_type: 'label',
    target_config: {},
    match_strategy: 'property',
    match_config: {},
    relationship_type: '',
    relationship_props: {}
  };

  // Reset form fields
  document.getElementById('link-name').value = '';
  document.getElementById('source-label').value = '';
  document.getElementById('source-where').value = '';
  document.getElementById('csv-data').value = '';
  document.getElementById('api-url').value = '';
  document.getElementById('api-jsonpath').value = '';
  document.getElementById('target-label-name').value = '';
  document.getElementById('target-graph-label').value = '';
  document.getElementById('match-source-field').value = '';
  document.getElementById('match-target-field').value = '';
  document.getElementById('match-cypher-query').value = '';
  document.getElementById('rel-type').value = '';
  document.getElementById('rel-props-container').innerHTML = '';
  document.getElementById('preview-container').innerHTML = '<div class="empty-state small">Click "Load Preview" to see sample matches</div>';

  // Reset button states
  document.querySelectorAll('.source-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.source === 'graph');
  });
  document.querySelectorAll('.target-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.target === 'label');
  });
  document.querySelectorAll('.match-strategy-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.strategy === 'property');
  });

  showSourceConfig('graph');
  showTargetConfig('label');
  showMatchConfig('property');

  document.getElementById('btn-delete-def').style.display = 'none';
  navigateToStep(1);
}

function showWizard() {
  document.getElementById('link-wizard').style.display = 'block';
  document.getElementById('wizard-title').textContent = currentLink ? 'Edit Link Definition' : 'New Link Definition';
}

function navigateStep(delta) {
  const newStep = currentStep + delta;
  if (newStep >= 1 && newStep <= 4) {
    navigateToStep(newStep);
  }
}

function navigateToStep(step) {
  currentStep = step;

  // Update step indicators
  document.querySelectorAll('.wizard-step').forEach((el, idx) => {
    const stepNum = idx + 1;
    el.classList.remove('active', 'completed');
    if (stepNum < step) {
      el.classList.add('completed');
    } else if (stepNum === step) {
      el.classList.add('active');
    }
  });

  // Update content visibility
  document.querySelectorAll('.wizard-step-content').forEach((el, idx) => {
    el.classList.toggle('active', idx + 1 === step);
  });

  // Update navigation buttons
  document.getElementById('btn-prev').style.display = step > 1 ? 'inline-block' : 'none';
  document.getElementById('btn-next').style.display = step < 4 ? 'inline-block' : 'none';
  document.getElementById('btn-execute').style.display = step === 4 ? 'inline-block' : 'none';
}

function showSourceConfig(type) {
  document.querySelectorAll('.source-config').forEach(el => el.style.display = 'none');
  document.getElementById(`source-${type}`).style.display = 'block';
}

function showTargetConfig(type) {
  document.querySelectorAll('.target-config').forEach(el => el.style.display = 'none');
  document.getElementById(`target-${type}`).style.display = 'block';
}

function showMatchConfig(strategy) {
  document.querySelectorAll('.match-config').forEach(el => el.style.display = 'none');
  document.getElementById(`match-${strategy}`).style.display = 'block';
}

function addRelationshipProperty() {
  const container = document.getElementById('rel-props-container');
  const row = document.createElement('div');
  row.className = 'property-row';
  row.innerHTML = `
    <input type="text" class="form-control form-control-sm" placeholder="key" data-prop-key />
    <input type="text" class="form-control form-control-sm" placeholder="value" data-prop-value />
    <button class="btn btn-sm btn-outline-danger btn-sm-icon" onclick="this.parentElement.remove()">×</button>
  `;
  container.appendChild(row);
}

function renderRelationshipProps() {
  const container = document.getElementById('rel-props-container');
  container.innerHTML = '';
  Object.entries(wizardData.relationship_props || {}).forEach(([key, value]) => {
    const row = document.createElement('div');
    row.className = 'property-row';
    row.innerHTML = `
      <input type="text" class="form-control form-control-sm" value="${key}" data-prop-key />
      <input type="text" class="form-control form-control-sm" value="${value}" data-prop-value />
      <button class="btn btn-sm btn-outline-danger btn-sm-icon" onclick="this.parentElement.remove()">×</button>
    `;
    container.appendChild(row);
  });
}

function collectWizardData() {
  // Step 1: Source
  wizardData.name = document.getElementById('link-name').value.trim();

  if (wizardData.source_type === 'graph') {
    wizardData.source_config = {
      label: document.getElementById('source-label').value.trim(),
      where_clause: document.getElementById('source-where').value.trim()
    };
  } else if (wizardData.source_type === 'csv') {
    wizardData.source_config = {
      csv_data: document.getElementById('csv-data').value.trim()
    };
  } else if (wizardData.source_type === 'api') {
    wizardData.source_config = {
      url: document.getElementById('api-url').value.trim(),
      json_path: document.getElementById('api-jsonpath').value.trim()
    };
  }

  // Step 2: Target
  if (wizardData.target_type === 'label') {
    wizardData.target_config = {
      label: document.getElementById('target-label-name').value.trim()
    };
  } else if (wizardData.target_type === 'graph') {
    wizardData.target_config = {
      label: document.getElementById('target-graph-label').value.trim()
    };
  }

  if (wizardData.match_strategy === 'property') {
    wizardData.match_config = {
      source_field: document.getElementById('match-source-field').value.trim(),
      target_field: document.getElementById('match-target-field').value.trim()
    };
  } else if (wizardData.match_strategy === 'cypher') {
    wizardData.match_config = {
      cypher: document.getElementById('match-cypher-query').value.trim()
    };
  } else if (wizardData.match_strategy === 'id') {
    wizardData.match_config = {};
  }

  // Step 3: Relationship
  wizardData.relationship_type = document.getElementById('rel-type').value.trim();

  const props = {};
  document.querySelectorAll('#rel-props-container .property-row').forEach(row => {
    const key = row.querySelector('[data-prop-key]').value.trim();
    const value = row.querySelector('[data-prop-value]').value.trim();
    if (key) {
      props[key] = value;
    }
  });
  wizardData.relationship_props = props;

  return wizardData;
}

function saveLinkDefinition() {
  const data = collectWizardData();

  if (!data.name) {
    showToast('Link name is required', 'error');
    return;
  }

  if (!data.relationship_type) {
    showToast('Relationship type is required', 'error');
    return;
  }

  showToast('Saving link definition...', 'info');

  fetch('/api/links', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(r => r.json())
    .then(result => {
      if (result.status === 'success') {
        showToast('Link definition saved', 'success');
        wizardData.id = result.link.id;
        currentLink = result.link;
        loadLinkDefinitions();
        document.getElementById('btn-delete-def').style.display = 'inline-block';
      } else {
        showToast(`Failed to save: ${result.error}`, 'error');
      }
    })
    .catch(err => showToast('Failed to save link definition', 'error'));
}

function deleteLinkDefinition() {
  if (!wizardData.id) return;
  if (!confirm('Delete this link definition?')) return;

  fetch(`/api/links/${wizardData.id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(result => {
      if (result.status === 'success') {
        showToast('Link definition deleted', 'success');
        loadLinkDefinitions();
        document.getElementById('link-wizard').style.display = 'none';
      } else {
        showToast(`Failed to delete: ${result.error}`, 'error');
      }
    })
    .catch(err => showToast('Failed to delete link definition', 'error'));
}

function loadPreview() {
  const data = collectWizardData();

  if (!data.name || !data.relationship_type) {
    showToast('Please complete all required fields', 'error');
    return;
  }

  // Save first if new
  const savePromise = data.id ? Promise.resolve({ link: data }) :
    fetch('/api/links', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(r => r.json());

  document.getElementById('preview-loading').style.display = 'inline';

  savePromise
    .then(saveResult => {
      const linkId = saveResult.link.id;
      wizardData.id = linkId;

      return fetch(`/api/links/${linkId}/preview`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ limit: 10 })
      });
    })
    .then(r => r.json())
    .then(result => {
      document.getElementById('preview-loading').style.display = 'none';

      if (result.status === 'success') {
        renderPreview(result.matches || []);
      } else {
        showToast(`Preview failed: ${result.error}`, 'error');
      }
    })
    .catch(err => {
      document.getElementById('preview-loading').style.display = 'none';
      showToast('Failed to load preview', 'error');
    });
}

function renderPreview(matches) {
  const container = document.getElementById('preview-container');

  if (matches.length === 0) {
    container.innerHTML = '<div class="empty-state small">No matches found</div>';
    return;
  }

  container.innerHTML = `
    <div class="small" style="margin-bottom: 0.5rem; font-weight: 500;">
      Sample Matches (${matches.length}):
    </div>
    <div class="match-preview">
      ${matches.map(match => {
        const source = match.source || {};
        const target = match.target || {};
        return `
          <div class="match-item">
            <div><strong>Source:</strong> ${JSON.stringify(source).substring(0, 100)}...</div>
            <div><strong>Target:</strong> ${JSON.stringify(target).substring(0, 100)}...</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function executeLink() {
  if (!wizardData.id) {
    showToast('Please save the definition first', 'error');
    return;
  }

  if (!confirm('Execute this link workflow? This will create relationships in Neo4j.')) {
    return;
  }

  showToast('Starting execution...', 'info');

  fetch(`/api/links/${wizardData.id}/execute`, { method: 'POST' })
    .then(r => r.json())
    .then(result => {
      if (result.status === 'success') {
        const jobId = result.job_id;
        showToast('Execution started, polling for status...', 'info');
        pollJobStatus(jobId);
      } else {
        showToast(`Execution failed: ${result.error}`, 'error');
      }
    })
    .catch(err => showToast('Failed to execute link', 'error'));
}

function pollJobStatus(jobId) {
  const interval = setInterval(() => {
    fetch(`/api/links/jobs/${jobId}`)
      .then(r => r.json())
      .then(result => {
        if (result.status === 'success') {
          const job = result.job;

          if (job.status === 'completed') {
            clearInterval(interval);
            showToast(`Execution completed! Created ${job.executed_count} relationships.`, 'success');
          } else if (job.status === 'failed') {
            clearInterval(interval);
            showToast(`Execution failed: ${job.error}`, 'error');
          }
        }
      })
      .catch(err => {
        clearInterval(interval);
        showToast('Failed to poll job status', 'error');
      });
  }, 2000);
}
</script>
{% endblock %}
