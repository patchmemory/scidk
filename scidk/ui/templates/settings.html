{% extends 'base.html' %}
{% block title %}SciDK - Settings{% endblock %}
{% block content %}
<h1>Settings</h1>
<p class="small">Basic runtime information and counts.</p>
<ul>
  <li>Host: {{ info.host }}</li>
  <li>Port: {{ info.port }}</li>
  <li>Debug: {{ info.debug }}</li>
  <li>Datasets: {{ info.dataset_count }}</li>
  <li>Interpreters: {{ info.interpreter_count }}</li>
</ul>
<div class="small" style="margin:.5rem 0;">
  <span class="badge">Channel: {{ info.channel or 'stable' }}</span>
  <span class="badge" title="Providers">Providers: {{ info.providers }}</span>
  <span class="badge" title="Files viewer">Files viewer: {{ info.files_viewer or '(default)' }}</span>
</div>

<section style="margin-top:1rem">
  <h2>Neo4j Connection</h2>
  <div class="row g-2" style="max-width:720px">
    <div class="col-12 col-md-6">
      <label class="form-label small" for="neo4j-uri">URI</label>
      <input id="neo4j-uri" type="text" class="form-control form-control-sm" placeholder="bolt://localhost:7687" />
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small" for="neo4j-user">User</label>
      <input id="neo4j-user" type="text" class="form-control form-control-sm" placeholder="neo4j" />
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small" for="neo4j-db">Database (optional)</label>
      <input id="neo4j-db" type="text" class="form-control form-control-sm" placeholder="neo4j" />
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label small" for="neo4j-pass">Password</label>
      <div style="display:flex; gap:.5rem; align-items:center">
        <input id="neo4j-pass" type="password" class="form-control form-control-sm" placeholder="••••••" />
        <div class="form-check">
          <input id="neo4j-pass-show" type="checkbox" class="form-check-input" />
          <label class="form-check-label small" for="neo4j-pass-show">Show</label>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6" style="display:flex; gap:.5rem; align-items:end">
      <button id="neo4j-save" class="btn btn-sm btn-outline-secondary">Save</button>
      <button id="neo4j-connect" class="btn btn-sm btn-primary">Connect</button>
      <button id="neo4j-disconnect" class="btn btn-sm btn-outline-danger" style="display:none">Disconnect</button>
      <div id="neo4j-light" title="Disconnected" style="width:12px; height:12px; border-radius:50%; background:#000; border:1px solid #333; margin-left:.5rem"></div>
      <span id="neo4j-status-text" class="small"></span>
    </div>
  </div>
  <details style="margin-top:.5rem"><summary class="small">Advanced / Health</summary>
    <div style="display:flex; gap:.5rem; align-items:center; margin:.5rem 0">
      <button id="btn-test-graph" class="btn btn-sm btn-outline-primary">Test Graph Connection</button>
      <span id="graph-health-status" class="small"></span>
    </div>
    <p class="small">You can also set env vars: NEO4J_URI, NEO4J_USER, NEO4J_PASSWORD, SCIDK_NEO4J_DATABASE</p>
    <p class="small" style="margin:.25rem 0 0 0;">If your Neo4j has authentication disabled, set environment variable <code>NEO4J_AUTH=none</code> before starting the app.</p>
  </details>
</section>

<section style="margin-top:1rem">
  <h2>Interpreters</h2>
  <p class="small">Registered interpreter mappings and selection rules. See full page at <a href="/interpreters">/interpreters</a>.</p>
  <h3 class="small">Mappings (extension → interpreter ids)</h3>
  <ul>
    {% for ext, ids in (mappings or {}).items() %}
      <li><code>{{ ext }}</code> → {{ ids }}</li>
    {% else %}
      <li class="small">No mappings.</li>
    {% endfor %}
  </ul>
  <h3 class="small">Rules</h3>
  <ul>
    {% for r in (rules or []) %}
      <li><code>{{ r.id }}</code> → interpreter_id={{ r.interpreter_id }}, pattern={{ r.pattern }}, priority={{ r.priority }}</li>
    {% else %}
      <li class="small">No rules.</li>
    {% endfor %}
  </ul>

  <h3 style="margin-top:1rem">Interpreter toggles</h3>
  <p class="small">Enable or disable interpreters globally. Changes persist to settings when possible. If CLI env overrides are set (SCIDK_ENABLE_INTERPRETERS/SCIDK_DISABLE_INTERPRETERS), those take precedence and are shown as source=cli.</p>
  <div id="interp-alert" class="small" style="margin:.25rem 0; color:#b00020; display:none">
    Effective view is controlled by CLI env overrides; toggle effects may be masked.
    Unset SCIDK_ENABLE_INTERPRETERS/SCIDK_DISABLE_INTERPRETERS to allow GUI control.
    <div id="interp-env" class="small" style="margin-top:.25rem"></div>
  </div>
  <div style="overflow:auto; max-width: 100%">
    <table id="interp-table">
      <thead>
        <tr>
          <th style="min-width:160px">Interpreter</th>
          <th>Extensions</th>
          <th>Enabled</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    (function(){
      async function fetchEffective(){
        const r = await fetch('/api/interpreters?view=effective');
        if(!r.ok){ toast('Failed to load interpreters', 'error'); return []; }
        return await r.json();
      }
      function render(rows){
        const tb = document.querySelector('#interp-table tbody');
        tb.innerHTML='';
        let src = null;
        rows.forEach(it => {
          if (!src && it.source) src = it.source;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${it.name || it.id}</strong><div class="small">${it.id}</div></td>
            <td class="small">${(it.globs||[]).join(', ')}</td>
            <td>
              <label class="form-check">
                <input type="checkbox" class="form-check-input" ${it.enabled ? 'checked' : ''} data-iid="${it.id}" />
              </label>
            </td>
            <td><span class="badge">${it.source || ''}</span></td>
          `;
          tb.appendChild(tr);
        });
        const alertEl = document.getElementById('interp-alert');
        const envEl = document.getElementById('interp-env');
        if (src === 'cli') {
          alertEl.style.display = 'block';
          // Fetch debug info to show env values
          try {
            fetch('/api/interpreters/effective_debug').then(r => r.json()).then(info => {
              const en = ((info.env || {}).enable_raw || []).join(', ');
              const dis = ((info.env || {}).disable_raw || []).join(', ');
              const unkEn = (((info.env || {}).unknown || {}).enable || []).join(', ');
              const unkDis = (((info.env || {}).unknown || {}).disable || []).join(', ');
              let extra = '';
              if (en || dis) {
                extra += `Env ENABLE=[${en||'none'}], DISABLE=[${dis||'none'}]. `;
              }
              if (unkEn || unkDis) {
                extra += `Unknown ids ignored → enable:[${unkEn||'none'}], disable:[${unkDis||'none'}].`;
              }
              envEl.textContent = extra;
            });
          } catch(e) { /* ignore */ }
        } else {
          alertEl.style.display = 'none';
          envEl.textContent = '';
        }
        // Wire change handlers
        tb.querySelectorAll('input[type=checkbox][data-iid]').forEach(chk => {
          chk.addEventListener('change', async (e) => {
            const iid = e.target.getAttribute('data-iid');
            const enabled = e.target.checked;
            try {
              const resp = await fetch(`/api/interpreters/${encodeURIComponent(iid)}/toggle`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled })
              });
              if (!resp.ok) throw new Error('HTTP ' + resp.status);
              // Refresh to reflect effective state/source
              const eff = await fetchEffective();
              render(eff);
              toast(`Updated ${iid}: ${enabled ? 'enabled' : 'disabled'}`, 'success', 1500);
            } catch (err){
              toast('Failed to update ' + iid + ': ' + err, 'error');
              // revert checkbox
              e.target.checked = !enabled;
            }
          });
        });
      }
      fetchEffective().then(render);
    })();
  </script>
</section>

<section style="margin-top:1rem">
  <h2>Plugins</h2>
  <p class="small">Plugin registry summary. See full page at <a href="/plugins">/plugins</a>.</p>
  <ul>
    <li class="small">Registered interpreter count: {{ interp_count or 0 }}</li>
    <li class="small">Extensions mapped: {{ ext_count or 0 }}</li>
  </ul>
</section>

<section style="margin-top:1rem">
  <h2>Rclone Interpretation</h2>
  <p class="small">Tune streaming-based interpretation from rclone remotes. For very large scans, consider mounting the remote.</p>
  <div class="row g-2" style="max-width:640px">
    <div class="col-12 col-md-6">
      <label class="form-label small" for="rc-suggest">Suggest-mount threshold (files)</label>
      <input id="rc-suggest" type="number" min="0" step="50" class="form-control form-control-sm" placeholder="400" />
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label small" for="rc-batch">Max files per batch</label>
      <input id="rc-batch" type="number" min="100" max="2000" step="50" class="form-control form-control-sm" placeholder="1000" />
    </div>
    <div class="col-12" style="display:flex; gap:.5rem; align-items:end">
      <button id="rc-save" class="btn btn-sm btn-primary">Save</button>
      <span id="rc-msg" class="small"></span>
    </div>
  </div>
</section>

<section style="margin-top:1rem">
  <h2>Rclone Mounts</h2>
  <p class="small">Manage rclone mounts under ./data/mounts.</p>
  <div class="row g-2" style="max-width:780px">
    <div class="col-12 col-md-3">
      <label class="form-label small" for="rc-remote">Remote</label>
      <input id="rc-remote" type="text" class="form-control form-control-sm" placeholder="gdrive:" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small" for="rc-subpath">Subpath (optional)</label>
      <input id="rc-subpath" type="text" class="form-control form-control-sm" placeholder="folder/path" />
    </div>
    <div class="col-8 col-md-3">
      <label class="form-label small" for="rc-name">Name</label>
      <input id="rc-name" type="text" class="form-control form-control-sm" placeholder="my_mount" />
    </div>
    <div class="col-4 col-md-2" style="display:flex; align-items:end; gap:.5rem">
      <div class="form-check">
        <input id="rc-ro" class="form-check-input" type="checkbox" checked />
        <label for="rc-ro" class="form-check-label small">Read-only</label>
      </div>
      <button id="rc-create" class="btn btn-sm btn-primary">Create</button>
    </div>
  </div>
  <div style="margin-top:.5rem">
    <button id="rc-refresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
  </div>
  <table class="table table-sm" style="margin-top:.5rem">
    <thead>
      <tr><th>Name</th><th>Target</th><th>Path</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="rc-table-body">
      <tr><td colspan="5" class="small">No mounts.</td></tr>
    </tbody>
  </table>
  <pre id="rc-logs" class="small" style="max-height:200px; overflow:auto; background:#111; color:#ddd; padding:.5rem"></pre>
  <p class="small text-muted">Note: On Windows, cmount/WinFsp may be required; this UI targets Linux/macOS primarily.</p>
</section>
{% endblock %}
{% block head %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-test-graph');

    // Rclone Interpretation settings
    const rcSuggest = document.getElementById('rc-suggest');
    const rcBatch = document.getElementById('rc-batch');
    const rcSave = document.getElementById('rc-save');
    const rcMsg = document.getElementById('rc-msg');
    async function loadRcloneInterp(){
      try { const r = await fetch('/api/settings/rclone-interpret'); const j = await r.json(); if (rcSuggest) rcSuggest.value = (j.suggest_mount_threshold ?? 400); if (rcBatch) rcBatch.value = (j.max_files_per_batch ?? 1000); }
      catch(e){ if (rcMsg) rcMsg.textContent = 'Failed to load: ' + e; }
    }
    async function saveRcloneInterp(){
      const payload = { suggest_mount_threshold: Number(rcSuggest && rcSuggest.value || 400), max_files_per_batch: Number(rcBatch && rcBatch.value || 1000) };
      try { const r = await fetch('/api/settings/rclone-interpret', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); const j = await r.json(); if (!r.ok) { rcMsg.textContent = 'Save failed: ' + (j.error || r.status); } else { rcMsg.textContent = 'Saved.'; setTimeout(()=>{rcMsg.textContent='';},1500); } }
      catch(e){ rcMsg.textContent = 'Save failed: ' + e; }
    }
    if (rcSave) rcSave.addEventListener('click', async (e) => { e.preventDefault(); await saveRcloneInterp(); });
    loadRcloneInterp();

    // Rclone mounts UI bindings
    const rcEnabled = {{ 'true' if rclone_mounts_feature else 'false' }};
    const elRemote = document.getElementById('rc-remote');
    const elSub = document.getElementById('rc-subpath');
    const elName = document.getElementById('rc-name');
    const elRO = document.getElementById('rc-ro');
    const btnCreate = document.getElementById('rc-create');
    const btnRefresh = document.getElementById('rc-refresh');
    const tblBody = document.getElementById('rc-table-body');
    const logsBox = document.getElementById('rc-logs');

    async function refreshMounts(){
      if (!rcEnabled || !tblBody) return;
      try {
        const r = await fetch('/api/rclone/mounts');
        const j = await r.json();
        tblBody.innerHTML = '';
        if (!Array.isArray(j) || j.length === 0){
          tblBody.innerHTML = '<tr><td colspan="5" class="small">No mounts.</td></tr>';
          return;
        }
        for (const m of j){
          const tr = document.createElement('tr');
          const target = (m.remote || '') + (m.subpath || '');
          tr.innerHTML = `<td>${m.name||m.id}</td><td>${target}</td><td>${m.path||''}</td><td>${m.status||''}</td>`;
          const tdAct = document.createElement('td');
          const btnLogs = document.createElement('button'); btnLogs.textContent = 'Logs'; btnLogs.className = 'btn btn-sm btn-outline-secondary';
          btnLogs.addEventListener('click', async () => {
            logsBox.textContent = 'Loading logs...';
            const r2 = await fetch(`/api/rclone/mounts/${encodeURIComponent(m.id)}/logs?tail=200`);
            const j2 = await r2.json();
            logsBox.textContent = (j2.lines||[]).join('\n');
          });
          const btnDel = document.createElement('button'); btnDel.textContent = 'Unmount'; btnDel.className = 'btn btn-sm btn-outline-danger'; btnDel.style.marginLeft = '.25rem';
          btnDel.addEventListener('click', async () => {
            if (!confirm('Unmount ' + (m.name||m.id) + '?')) return;
            const r3 = await fetch(`/api/rclone/mounts/${encodeURIComponent(m.id)}`, { method:'DELETE' });
            await refreshMounts();
          });
          tdAct.appendChild(btnLogs); tdAct.appendChild(btnDel);
          tr.appendChild(tdAct);
          tblBody.appendChild(tr);
        }
      } catch(e){ /* ignore */ }
    }
    async function createMount(){
      if (!rcEnabled || !btnCreate) return;
      try {
        const payload = { remote: (elRemote && elRemote.value)||'', subpath: (elSub && elSub.value)||'', name: (elName && elName.value)||'', read_only: elRO && elRO.checked };
        const r = await fetch('/api/rclone/mounts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await r.json();
        if (!r.ok){ alert('Create failed: ' + (j.error || r.status)); return; }
        elName && (elName.value = '');
        await refreshMounts();
      } catch(e) { alert('Create failed: ' + e); }
    }
    if (btnCreate) btnCreate.addEventListener('click', async (e) => { e.preventDefault(); await createMount(); });
    if (btnRefresh) btnRefresh.addEventListener('click', async (e) => { e.preventDefault(); await refreshMounts(); });
    refreshMounts();
    const status = document.getElementById('graph-health-status');
    async function testGraph(){
      status.textContent = 'Checking...';
      try {
        const r = await fetch('/api/health/graph');
        const j = await r.json();
        if (!r.ok){ status.textContent = 'Error: ' + (j.error || r.status); return; }
        const neo = j.neo4j || {};
        const parts = [
          `backend=${j.backend}`,
          `in_memory_ok=${j.in_memory_ok}`,
          `neo4j_configured=${neo.configured}`,
          `neo4j_connectable=${neo.connectable}`
        ];
        if (neo.error) parts.push('neo4j_error=' + neo.error);
        status.textContent = parts.join(' — ');
      } catch(e){
        status.textContent = 'Health check failed: ' + (e && e.message ? e.message : e);
      }
    }
    if (btn) btn.addEventListener('click', testGraph);

    // Neo4j settings UI
    const elUri = document.getElementById('neo4j-uri');
    const elUser = document.getElementById('neo4j-user');
    const elDb = document.getElementById('neo4j-db');
    const elPass = document.getElementById('neo4j-pass');
    const elShow = document.getElementById('neo4j-pass-show');
    const btnSave = document.getElementById('neo4j-save');
    const btnConn = document.getElementById('neo4j-connect');
    const btnDisc = document.getElementById('neo4j-disconnect');
    const light = document.getElementById('neo4j-light');
    const statusText = document.getElementById('neo4j-status-text');

    if (elShow) elShow.addEventListener('change', () => {
      elPass.type = elShow.checked ? 'text' : 'password';
    });

    function setLight(ok){
      if (!light) return;
      light.style.background = ok ? '#19c37d' : '#000';
      light.title = ok ? 'Connected' : 'Disconnected';
    }
    function setButtons(ok){
      if (btnConn) btnConn.style.display = ok ? 'none' : '';
      if (btnDisc) btnDisc.style.display = ok ? '' : 'none';
    }
    function renderStatus(j){
      setLight(!!j.connected);
      setButtons(!!j.connected);
      statusText.textContent = j.error ? ('Error: ' + j.error) : (j.connected ? 'Connected' : 'Not connected');
    }

    async function loadCfg(){
      try {
        const r = await fetch('/api/settings/neo4j');
        const j = await r.json();
        if (elUri) elUri.value = j.uri || '';
        if (elUser) elUser.value = j.user || '';
        if (elDb) elDb.value = j.database || '';
        setLight(!!j.connected);
        setButtons(!!j.connected);
        statusText.textContent = j.connected ? 'Connected' : (j.last_error ? ('Error: ' + j.last_error) : 'Not connected');
      } catch(e) {
        statusText.textContent = 'Failed to load settings';
      }
    }

    async function saveCfg(){
      const payload = {
        uri: (elUri && elUri.value) || '',
        user: (elUser && elUser.value) || '',
        // Only send password if non-empty to avoid clearing stored secret unintentionally
        ...(elPass && elPass.value ? { password: elPass.value } : {}),
        database: (elDb && elDb.value) || ''
      };
      try {
        const r = await fetch('/api/settings/neo4j', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if (!r.ok){ const j = await r.json(); alert('Save failed: ' + (j.error || r.status)); return; }
        // Clear password field in UI after save
        if (elPass) elPass.value = '';
      } catch(e){ alert('Save failed: ' + e); }
    }

    async function connect(){
      try {
        const r = await fetch('/api/settings/neo4j/connect', { method: 'POST' });
        const j = await r.json();
        renderStatus(j);
      } catch(e) {
        statusText.textContent = 'Connect failed';
      }
    }
    async function disconnect(){
      try {
        const r = await fetch('/api/settings/neo4j/disconnect', { method: 'POST' });
        const j = await r.json();
        renderStatus(j);
      } catch(e) {
        statusText.textContent = 'Disconnect failed';
      }
    }

    if (btnSave) btnSave.addEventListener('click', async (e) => { e.preventDefault(); await saveCfg(); });
    if (btnConn) btnConn.addEventListener('click', async (e) => { e.preventDefault(); await saveCfg(); await connect(); });
    if (btnDisc) btnDisc.addEventListener('click', async (e) => { e.preventDefault(); await disconnect(); });

    // Optional: clear stored password explicitly
    const btnClear = document.getElementById('neo4j-clear-pass');
    if (btnClear) btnClear.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const r = await fetch('/api/settings/neo4j', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ clear_password: true }) });
        if (!r.ok){ const j = await r.json(); alert('Clear failed: ' + (j.error || r.status)); return; }
        if (elPass) elPass.value = '';
        alert('Password cleared in server settings.');
      } catch(err){ alert('Clear failed: ' + err); }
    });

    loadCfg();
  });
</script>
{% endblock %}
