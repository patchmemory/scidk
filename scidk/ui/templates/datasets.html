{% extends 'base.html' %}
{% block title %}SciDK - Files{% endblock %}
{% block content %}
<h1>Files</h1>
<section>
  <h2>Load Directory</h2>
  <form action="/scan" method="post">
    <label>Path: <input type="text" name="path" placeholder="/path/to/scan" style="width: 24rem"/></label>
    <label><input type="checkbox" name="recursive" checked/> Recursive</label>
    <button type="submit">Scan</button>
  </form>
  <div class="actions" style="margin-top:.5rem; align-items: baseline; gap: .5rem;">
    <label class="small" for="recent-scans">Recent scans:</label>
    <select id="recent-scans">
      <option value="">-- select --</option>
      {% for s in recent_scans or [] %}
        <option value="{{ s.id }}">{{ s.path }} — {{ s.file_count }} files — {{ '%.0f'|format((s.ended or s.started) or 0) }}</option>
      {% endfor %}
    </select>
    <button id="open-scan" type="button">Open</button>
    {% if selected_scan %}
      <span class="small">Filtering by scan <code>{{ selected_scan.id }}</code> for <code>{{ selected_scan.path }}</code> (recursive: {{ selected_scan.recursive }}) — <a href="/datasets">Clear filter</a></span>
    {% endif %}
  </div>
  {% if directories %}
    <details style="margin-top:.5rem;">
      <summary class="small">Previously scanned directories (this session)</summary>
      <ul>
        {% for d in directories %}
          <li><code>{{ d.path }}</code> — files: {{ d.scanned }}, recursive: {{ d.recursive }}{% if d.source %} — <span class="badge">{{ d.source }}</span>{% endif %}</li>
        {% endfor %}
      </ul>
    </details>
  {% endif %}
</section>

<section>
{% if selected_scan and (datasets|length == 0) %}
  <p class="small">This scan did not add any new datasets (MVP shows newly added files only). Clear filter to see all datasets.</p>
{% endif %}
<table>
  <thead>
  <tr>
    <th>Path</th>
    <th>Ext</th>
    <th>Size</th>
    <th>Interpreters</th>
  </tr>
  </thead>
  <tbody>
  {% for d in datasets %}
    <tr>
      <td><a href="/datasets/{{ d.id }}">{{ d.path }}</a></td>
      <td>{{ d.extension }}</td>
      <td class="small">{{ d.size_bytes }}</td>
      <td class="small">{{ d.interpretations.keys()|list }}</td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="small">No datasets yet.</td></tr>
  {% endfor %}
  </tbody>
</table>
</section>
{% endblock %}
{% block head %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('recent-scans');
    const btn = document.getElementById('open-scan');
    if (select && btn) {
      btn.addEventListener('click', () => {
        const id = select.value;
        if (id) { window.location = '/datasets?scan_id=' + encodeURIComponent(id); }
      });
      select.addEventListener('change', () => {
        const id = select.value;
        if (id) { window.location = '/datasets?scan_id=' + encodeURIComponent(id); }
      });
    }
  });
</script>
{% endblock %}