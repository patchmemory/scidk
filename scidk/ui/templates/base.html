<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{% block title %}-SciDK->{% endblock %}</title>
  <style>
    :root { --fg:#222; --muted:#666; --bg:#fff; --accent:#0a6; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; color: var(--fg); background: var(--bg); }
    header { display:flex; align-items: center; justify-content: flex-start; gap: .75rem; padding: 0.75rem 1rem; border-bottom: 1px solid #eee; position: sticky; top:0; background: var(--bg); }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    nav a { color: var(--fg); text-decoration: none; padding: 0.25rem 0.5rem; border-radius: 4px; }
    nav a + a { margin-left: 0.25rem; }
    nav a:hover { background: #f3f3f3; }
    main { padding: 1rem 0.5rem; max-width: 100%; margin: 0; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #eee; padding: 8px; text-align: left; }
    th { background: #f9f9f9; }
    .small { color: var(--muted); font-size: 0.9em; }
    .actions { display: flex; gap: .5rem; align-items: center; }
    form.inline { display: inline-block; }
    /* Toast styles */
    #toast-container { position: fixed; top: 12px; right: 12px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: #333; color: #fff; padding: 10px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); opacity: 0.95; font-size: 0.9em; }
    .toast.error { background: #b00020; }
    .toast.success { background: #0a6; }
  </style>
  {% block head %}{% endblock %}
</head>
<body>
<header data-testid="header">
  <h1><a href="/" style="text-decoration:none;color:inherit;font-family:monospace;letter-spacing:0.02em" data-testid="nav-home">-SciDK-></a></h1>
  <nav data-testid="nav">
    <!-- SciDK logo links to landing page (Settings) -->
    <a href="/datasets" data-testid="nav-files">Files</a>
    <a href="/labels" data-testid="nav-labels">Labels</a>
    <a href="/integrate" data-testid="nav-integrate">Integrations</a>
    <a href="/map" data-testid="nav-maps">Maps</a>
    <a href="/chat" data-testid="nav-chats">Chats</a>
  </nav>
  <div id="auth-status" style="margin-left:auto; display:none;">
    <span id="auth-username" style="color:var(--muted); font-size:0.9em; margin-right:0.5rem;"></span>
    <a href="#" id="logout-btn" data-testid="logout-btn" style="color:var(--accent); text-decoration:none; padding:0.25rem 0.5rem; border-radius:4px;">Logout</a>
  </div>
</header>
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>
<main data-testid="main">
  {% block content %}{% endblock %}
</main>
<script>
  (function(){
    const containerId = 'toast-container';
    function ensureContainer(){
      let el = document.getElementById(containerId);
      if (!el) { el = document.createElement('div'); el.id = containerId; document.body.appendChild(el); }
      return el;
    }
    function makeToast(message, type='error', timeoutMs=3000){
      const c = ensureContainer();
      const t = document.createElement('div');
      t.className = 'toast ' + (type || '');
      t.textContent = message;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 300ms'; }, Math.max(0, timeoutMs - 300));
      setTimeout(() => { t.remove(); }, timeoutMs);
    }
    window.toast = makeToast;
  })();

  // Auth status checking and logout functionality
  (function(){
    const authStatusDiv = document.getElementById('auth-status');
    const authUsernameSpan = document.getElementById('auth-username');
    const logoutBtn = document.getElementById('logout-btn');

    // Check auth status on page load
    async function checkAuthStatus() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();

        if (data.authenticated && data.username) {
          // Show logout button and username
          authUsernameSpan.textContent = data.username;
          authStatusDiv.style.display = 'flex';
          authStatusDiv.style.alignItems = 'center';
        } else {
          // Hide auth status (not authenticated or auth disabled)
          authStatusDiv.style.display = 'none';
        }
      } catch (error) {
        // Silently fail - auth status not critical for UI rendering
        console.error('Failed to check auth status:', error);
      }
    }

    // Handle logout click
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        try {
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            // Redirect to login page
            window.location.href = '/login';
          } else {
            window.toast('Logout failed', 'error');
          }
        } catch (error) {
          window.toast('Logout error', 'error');
        }
      });
    }

    // Check status on page load
    checkAuthStatus();
  })();

  // Activity Monitor and Auto-Lock functionality
  (function(){
    let activityMonitor = null;

    class ActivityMonitor {
      constructor(timeoutMinutes, onInactive) {
        this.timeoutMs = timeoutMinutes * 60 * 1000;
        this.lastActivity = Date.now();
        this.onInactive = onInactive;
        this.checkInterval = null;

        // Track user activity
        ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
          document.addEventListener(event, () => this.recordActivity(), { passive: true });
        });

        this.start();
      }

      recordActivity() {
        this.lastActivity = Date.now();
      }

      start() {
        this.checkInterval = setInterval(() => {
          if (Date.now() - this.lastActivity > this.timeoutMs) {
            this.onInactive();
          }
        }, 10000); // Check every 10 seconds
      }

      stop() {
        if (this.checkInterval) {
          clearInterval(this.checkInterval);
          this.checkInterval = null;
        }
      }

      updateTimeout(timeoutMinutes) {
        this.timeoutMs = timeoutMinutes * 60 * 1000;
        this.recordActivity(); // Reset timer when updating
      }
    }

    // Initialize auto-lock on page load
    async function initAutoLock() {
      try {
        // Check if auth is enabled
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();

        if (!authData.authenticated || !authData.auth_enabled) {
          // Auth not enabled or user not authenticated
          return;
        }

        // Check if session is already locked
        if (authData.session_locked) {
          showLockScreen(authData.username);
          return;
        }

        // Get auto-lock configuration
        const configResponse = await fetch('/api/settings/security/auto-lock');
        const configData = await configResponse.json();

        if (configData.status === 'success' && configData.config.enabled) {
          const timeoutMinutes = configData.config.timeout_minutes || 5;

          // Start activity monitor
          activityMonitor = new ActivityMonitor(timeoutMinutes, async () => {
            // Lock session
            try {
              const lockResponse = await fetch('/api/auth/lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
              });

              if (lockResponse.ok) {
                showLockScreen(authData.username);
              }
            } catch (error) {
              console.error('Failed to lock session:', error);
            }
          });
        }
      } catch (error) {
        console.error('Failed to initialize auto-lock:', error);
      }
    }

    function showLockScreen(username) {
      // Stop activity monitor while locked
      if (activityMonitor) {
        activityMonitor.stop();
      }

      // Create lock screen overlay
      const lockScreen = document.createElement('div');
      lockScreen.id = 'lock-screen';
      lockScreen.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      const lockDialog = document.createElement('div');
      lockDialog.style.cssText = `
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      `;

      const now = new Date();
      const timeStr = now.toLocaleTimeString();

      lockDialog.innerHTML = `
        <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">Session Locked</h2>
        <p class="small" style="margin: 0 0 1rem 0;">Locked at ${timeStr}</p>
        <p style="margin: 0 0 1rem 0;">User: <strong>${username || 'Unknown'}</strong></p>
        <form id="unlock-form" style="margin: 0;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
          <input
            type="password"
            id="unlock-password"
            placeholder="Enter password"
            required
            autofocus
            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;"
          />
          <button
            type="submit"
            style="width: 100%; padding: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 500;"
          >Unlock</button>
        </form>
        <p id="unlock-error" class="small" style="color: #b00020; margin: 0.5rem 0 0 0; display: none;"></p>
      `;

      lockScreen.appendChild(lockDialog);
      document.body.appendChild(lockScreen);

      // Handle unlock form submission
      const unlockForm = document.getElementById('unlock-form');
      const unlockPassword = document.getElementById('unlock-password');
      const unlockError = document.getElementById('unlock-error');

      unlockForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = unlockPassword.value;

        if (!password) {
          unlockError.textContent = 'Password is required';
          unlockError.style.display = 'block';
          return;
        }

        try {
          const response = await fetch('/api/auth/unlock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password }),
          });

          if (response.ok) {
            // Unlock successful - remove lock screen and restart activity monitor
            lockScreen.remove();

            // Restart activity monitor if it was active
            if (activityMonitor) {
              const configResponse = await fetch('/api/settings/security/auto-lock');
              const configData = await configResponse.json();
              if (configData.status === 'success' && configData.config.enabled) {
                activityMonitor.start();
              }
            }

            // Optionally show success toast
            window.toast('Session unlocked', 'success', 2000);
          } else {
            const data = await response.json();
            unlockError.textContent = data.error || 'Invalid password';
            unlockError.style.display = 'block';
            unlockPassword.value = '';
            unlockPassword.focus();
          }
        } catch (error) {
          unlockError.textContent = 'Unlock failed. Please try again.';
          unlockError.style.display = 'block';
          console.error('Unlock error:', error);
        }
      });

      // Focus password input
      unlockPassword.focus();
    }

    // Initialize on page load
    initAutoLock();

    // Export for external use
    window.scidkActivityMonitor = activityMonitor;
  })();
</script>

<!-- Browser notifications for alerts -->
<script src="/static/js/notifications.js"></script>

</body>
</html>
