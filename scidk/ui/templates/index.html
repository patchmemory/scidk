{% extends 'base.html' %}
{% block title %}SciDK - Home{% endblock %}
{% block content %}
<section>
  <h2>Scan Files</h2>
  <form action="/scan" method="post">
    <label>Path: <input type="text" name="path" placeholder="/path/to/scan" style="width: 24rem"/></label>
    <label><input type="checkbox" name="recursive" checked/> Recursive</label>
    <button type="submit">Scan</button>
  </form>
</section>

<section>
  <h2>Summary</h2>
  <p class="small">Saved filesystem scans summary (derived from current datasets).</p>
  <ul>
    <li>Total datasets: {{ datasets|length }}</li>
    <li>Unique extensions: {{ by_ext|length }}</li>
  </ul>
  <details>
    <summary class="small">By extension</summary>
    <ul>
      {% for ext, count in by_ext.items() %}
        <li><code>{{ ext or '(none)' }}</code>: {{ count }}</li>
      {% else %}
        <li class="small">No data.</li>
      {% endfor %}
    </ul>
  </details>

  <details open>
    <summary class="small">Last Scan Telemetry</summary>
    {% if telemetry and telemetry.last_scan %}
      <ul>
        <li>Path: <code>{{ telemetry.last_scan.path }}</code></li>
        <li>Recursive: {{ telemetry.last_scan.recursive }}</li>
        <li>Files scanned: {{ telemetry.last_scan.scanned }}</li>
        <li>Duration (sec): {{ '%.4f'|format(telemetry.last_scan.duration_sec) }}</li>
        <li>Started: {{ telemetry.last_scan.started }}</li>
        <li>Ended: {{ telemetry.last_scan.ended }}</li>
      </ul>
    {% else %}
      <p class="small">No scan run yet in this session.</p>
    {% endif %}
  </details>
</section>

<section>
  <h2>Chat</h2>
  <form id="chat-form-home">
    <input id="chat-input-home" type="text" placeholder="Ask something..." style="width: 70%" />
    <button type="submit">Send</button>
  </form>
  <div id="chat-history-home" class="small" style="margin-top:0.5rem"></div>
</section>

<section>
  <h2>Datasets (latest)</h2>
  <table>
    <thead>
    <tr>
      <th>Path</th>
      <th>Extension</th>
      <th>Size (bytes)</th>
      <th>Interpreted</th>
    </tr>
    </thead>
    <tbody>
    {% for d in datasets %}
      <tr>
        <td><a href="/datasets/{{ d.id }}">{{ d.path }}</a></td>
        <td>{{ d.extension }}</td>
        <td class="small">{{ d.size_bytes }}</td>
        <td class="small">{{ d.interpretations.keys()|list }}</td>
      </tr>
    {% else %}
      <tr><td colspan="4" class="small">No datasets yet. Use the Scan form above.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>

{% endblock %}
{% block head %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('chat-form-home');
    if (!form) return;
    const input = document.getElementById('chat-input-home');
    const history = document.getElementById('chat-history-home');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;
      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await resp.json();
        if (data && data.history) {
          history.innerHTML = data.history.map(m => `<div><strong>${m.role}:</strong> ${m.content}</div>`).join('');
        }
      } catch (err) {
        alert('Chat error: ' + err);
      } finally {
        input.value = '';
        input.focus();
      }
    });
  });
</script>
{% endblock %}