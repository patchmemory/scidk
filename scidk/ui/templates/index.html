{% extends 'base.html' %}
{% block title %}-SciDK->{% endblock %}
{% block head %}
<style>
  /* Override base.html main width constraint for settings page */
  main {
    max-width: 100% !important;
    padding: 0 !important;
  }

  .settings-container {
    display: flex;
    height: calc(100vh - 60px);
    gap: 0;
  }

  .settings-sidebar {
    width: 220px;
    min-width: 220px;
    background: #f9f9f9;
    border-right: 1px solid #e0e0e0;
    overflow-y: auto;
    padding: 1rem 0;
  }

  .settings-sidebar-item {
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    color: var(--fg);
    text-decoration: none;
    display: block;
    border-left: 3px solid transparent;
    transition: all 0.15s ease;
  }

  .settings-sidebar-item:hover {
    background: #f0f0f0;
  }

  .settings-sidebar-item.active {
    background: #fff;
    border-left-color: var(--accent);
    font-weight: 600;
  }

  .settings-content {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    max-width: 1100px;
  }

  .settings-section {
    display: none;
  }

  .settings-section.active {
    display: block;
  }

  .settings-section h1 {
    margin-top: 0;
    margin-bottom: 0.5rem;
  }

  .settings-section > p.small {
    margin-bottom: 1.5rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.85em;
    font-weight: 500;
    border-radius: 4px;
    background: #e9ecef;
    color: #495057;
    margin-right: 0.25rem;
  }
</style>
{% endblock %}
{% block content %}
<div class="settings-container">
  <!-- Sidebar Navigation -->
  <nav class="settings-sidebar">
    <a href="#general" class="settings-sidebar-item active" data-section="general">General</a>
    <a href="#neo4j" class="settings-sidebar-item" data-section="neo4j">Neo4j</a>
    <a href="#chat" class="settings-sidebar-item" data-section="chat">Chat</a>
    <a href="#interpreters" class="settings-sidebar-item" data-section="interpreters">Interpreters</a>
    <a href="#plugins" class="settings-sidebar-item" data-section="plugins">Plugins</a>
    <a href="#rclone" class="settings-sidebar-item" data-section="rclone">Rclone</a>
    <a href="#integrations" class="settings-sidebar-item" data-section="integrations">Integrations</a>
  </nav>

  <!-- Content Area -->
  <div class="settings-content">
    <!-- General Section -->
    <section id="general-section" class="settings-section active">
      <h1>General</h1>
      <p class="small">Basic runtime information and counts.</p>
      <ul>
        <li>Host: {{ info.host }}</li>
        <li>Port: {{ info.port }}</li>
        <li>Debug: {{ info.debug }}</li>
        <li>Datasets: {{ info.dataset_count }}</li>
        <li>Interpreters: {{ info.interpreter_count }}</li>
      </ul>
      <div class="small" style="margin:.5rem 0;">
        <span class="badge">Channel: {{ info.channel or 'stable' }}</span>
        <span class="badge" title="Providers">Providers: {{ info.providers }}</span>
        <span class="badge" title="Files viewer">Files viewer: {{ info.files_viewer or '(default)' }}</span>
      </div>

      <h3 style="margin-top:2rem">Configuration Management</h3>
      <p class="small">Export and import your complete SciDK configuration for backup or migration.</p>
      <div style="display:flex; gap:.75rem; align-items:center; margin:.75rem 0;">
        <button id="btn-export-config" class="btn btn-sm btn-primary" data-testid="export-config-button">Export Configuration</button>
        <button id="btn-import-config" class="btn btn-sm btn-outline-secondary" data-testid="import-config-button">Import Configuration</button>
        <button id="btn-view-backups" class="btn btn-sm btn-outline-secondary" data-testid="view-backups-button">View Backups</button>
      </div>
      <input type="file" id="config-file-input" accept=".zip" style="display:none;" />
      <div id="config-status" class="alert alert-info small" style="display:none; max-width:720px; margin-top:1rem;"></div>
      <p class="small" style="margin-top:0.5rem; color:#666">Exports all settings including Neo4j connection, interpreters, plugins, rclone mounts, and integration endpoints.</p>

      <h3 style="margin-top:2rem">Security</h3>
      <p class="small">Configure authentication and access control for this SciDK instance.</p>

      <!-- Current User Info (shown when logged in) -->
      <div id="current-user-info" style="display:none; background:#e7f3ff; border:1px solid #b3d9ff; border-radius:4px; padding:0.75rem; max-width:720px; margin-bottom:1rem">
        <div style="display:flex; align-items:center; gap:0.5rem">
          <span style="font-size:0.9em; font-weight:500">Logged in as:</span>
          <span id="current-username" style="font-size:0.9em"></span>
          <span id="current-role-badge" class="badge" style="background:#ffc107; color:#000"></span>
        </div>
      </div>

      <!-- Legacy auth setup form (shown only when no users exist yet) -->
      <div id="security-legacy-setup" style="background:#f9f9f9; border:1px solid #e0e0e0; border-radius:4px; padding:1rem; max-width:720px">
        <div style="margin-bottom:1rem">
          <label style="display:block; font-size:0.9em; margin-bottom:0.25rem; font-weight:500">Enable Authentication</label>
          <div style="display:flex; align-items:center; gap:0.5rem">
            <input type="checkbox" id="security-auth-enabled" style="width:18px; height:18px" />
            <label for="security-auth-enabled" class="small">Require login to access SciDK</label>
          </div>
        </div>
        <div id="security-auth-settings" style="display:none">
          <div style="margin-bottom:1rem">
            <label for="security-username" style="display:block; font-size:0.9em; margin-bottom:0.25rem; font-weight:500">Username</label>
            <input id="security-username" type="text" placeholder="admin" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px" />
          </div>
          <div style="margin-bottom:1rem">
            <label for="security-password" style="display:block; font-size:0.9em; margin-bottom:0.25rem; font-weight:500">Password</label>
            <div style="display:flex; gap:.5rem; align-items:center">
              <input id="security-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px" />
              <div style="display:flex; align-items:center; gap:0.25rem">
                <input id="security-password-show" type="checkbox" style="width:18px; height:18px" />
                <label for="security-password-show" class="small">Show</label>
              </div>
            </div>
          </div>
        </div>
        <button id="btn-save-security" data-testid="save-security-btn" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; margin-top:0.5rem">Save Security Settings</button>
        <p id="security-status" class="small" style="margin-top:0.75rem; color:#666"></p>
      </div>

      <!-- Message for regular users -->
      <div id="security-user-message" style="display:none; background:#f9f9f9; border:1px solid #e0e0e0; border-radius:4px; padding:1rem; max-width:720px">
        <p class="small" style="margin:0; color:#666">
          <strong>Your Account</strong><br>
          You are logged in with a regular user account. Contact an administrator to manage users or change security settings.
        </p>
      </div>

      <!-- Message for admins when multi-user is active -->
      <div id="security-admin-message" style="display:none; background:#f9f9f9; border:1px solid #e0e0e0; border-radius:4px; padding:1rem; max-width:720px">
        <p class="small" style="margin:0; color:#666">
          <strong>Authentication Active</strong><br>
          Multi-user authentication is enabled. Use the "Users" section below to manage user accounts and permissions.
        </p>
      </div>

      <!-- User Management (Admin Only) -->
      <div id="users-section-container" style="display:none; margin-top:2rem">
        <h3>Users</h3>
        <p class="small">Manage user accounts and permissions. <span class="badge" style="background:#ffc107; color:#000">Admin Only</span></p>
        <div style="background:#f9f9f9; border:1px solid #e0e0e0; border-radius:4px; padding:1rem; max-width:900px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
            <h4 style="margin:0">User List</h4>
            <button id="btn-add-user" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer">+ Add User</button>
          </div>
          <div id="users-list-container">
            <p class="small" style="color:#666">Loading users...</p>
          </div>
        </div>
      </div>

      <!-- Audit Log (Admin Only) -->
      <div id="audit-section-container" style="display:none; margin-top:2rem">
        <h3>Audit Log</h3>
        <p class="small">Security and user action logs. <span class="badge" style="background:#ffc107; color:#000">Admin Only</span></p>
        <div style="background:#f9f9f9; border:1px solid #e0e0e0; border-radius:4px; padding:1rem; max-width:900px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
            <h4 style="margin:0">Recent Activity</h4>
            <button id="btn-refresh-audit" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer">Refresh</button>
          </div>
          <div id="audit-log-container">
            <p class="small" style="color:#666">Loading audit log...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Neo4j Section -->
    <section id="neo4j-section" class="settings-section">
  <h1>Neo4j Connection</h1>
  <p class="small">Configure Neo4j database connection and settings.</p>
  <div class="row g-2" style="max-width:720px">
    <div class="col-12 col-md-6">
      <label class="form-label small" for="neo4j-uri">URI</label>
      <input id="neo4j-uri" type="text" class="form-control form-control-sm" placeholder="bolt://localhost:7687" />
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small" for="neo4j-user">User</label>
      <input id="neo4j-user" type="text" class="form-control form-control-sm" placeholder="neo4j" />
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small" for="neo4j-db">Database (optional)</label>
      <input id="neo4j-db" type="text" class="form-control form-control-sm" placeholder="neo4j" />
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label small" for="neo4j-pass">Password</label>
      <div style="display:flex; gap:.5rem; align-items:center">
        <input id="neo4j-pass" type="password" class="form-control form-control-sm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        <div class="form-check">
          <input id="neo4j-pass-show" type="checkbox" class="form-check-input" />
          <label class="form-check-label small" for="neo4j-pass-show">Show</label>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6" style="display:flex; gap:.5rem; align-items:end">
      <button id="neo4j-save" class="btn btn-sm btn-outline-secondary">Save</button>
      <button id="neo4j-connect" class="btn btn-sm btn-primary">Connect</button>
      <button id="neo4j-disconnect" class="btn btn-sm btn-outline-danger" style="display:none">Disconnect</button>
      <div id="neo4j-light" title="Disconnected" style="width:12px; height:12px; border-radius:50%; background:#000; border:1px solid #333; margin-left:.5rem"></div>
      <span id="neo4j-status-text" class="small"></span>
    </div>
  </div>
  <details style="margin-top:.5rem"><summary class="small">Advanced / Health</summary>
    <div style="display:flex; gap:.5rem; align-items:center; margin:.5rem 0">
      <button id="btn-test-graph" class="btn btn-sm btn-outline-primary">Test Graph Connection</button>
      <span id="graph-health-status" class="small"></span>
    </div>
    <p class="small">You can also set env vars: NEO4J_URI, NEO4J_USER, NEO4J_PASSWORD, SCIDK_NEO4J_DATABASE</p>
    <p class="small" style="margin:.25rem 0 0 0;">If your Neo4j has authentication disabled, set environment variable <code>NEO4J_AUTH=none</code> before starting the app.</p>
  </details>
    </section>

    <!-- Chat Section -->
    <section id="chat-section" class="settings-section">
      <h1>Chat</h1>
      <p class="small">Configure the chat interface for natural language queries over your Neo4j graph.</p>

      <h3>LLM Provider Configuration</h3>
      <div class="row g-2" style="max-width:720px; margin-bottom:2rem">
        <div class="col-12 col-md-6">
          <label class="form-label small" for="chat-llm-provider">Default LLM Provider</label>
          <select id="chat-llm-provider" class="form-select form-select-sm">
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="ollama">Ollama (Local)</option>
            <option value="none">None (Pattern-based only)</option>
          </select>
          <small class="form-text text-muted">Choose which LLM to use for entity extraction and query generation.</small>
        </div>
      </div>

      <!-- Anthropic Settings -->
      <div id="anthropic-settings" class="llm-provider-settings">
        <h4 class="small">Anthropic API Configuration</h4>
        <div class="row g-2" style="max-width:720px; margin-bottom:1rem">
          <div class="col-12 col-md-8">
            <label class="form-label small" for="chat-anthropic-key">API Key</label>
            <div style="display:flex; gap:.5rem; align-items:center">
              <input id="chat-anthropic-key" type="password" class="form-control form-control-sm" placeholder="sk-ant-api..." />
              <div class="form-check">
                <input id="chat-anthropic-key-show" type="checkbox" class="form-check-input" />
                <label class="form-check-label small" for="chat-anthropic-key-show">Show</label>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small" for="chat-anthropic-model">Model</label>
            <select id="chat-anthropic-model" class="form-select form-select-sm">
              <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
              <option value="claude-3-opus-20240229">Claude 3 Opus</option>
              <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
            </select>
          </div>
        </div>
      </div>

      <!-- OpenAI Settings -->
      <div id="openai-settings" class="llm-provider-settings" style="display:none">
        <h4 class="small">OpenAI API Configuration</h4>
        <div class="row g-2" style="max-width:720px; margin-bottom:1rem">
          <div class="col-12 col-md-8">
            <label class="form-label small" for="chat-openai-key">API Key</label>
            <div style="display:flex; gap:.5rem; align-items:center">
              <input id="chat-openai-key" type="password" class="form-control form-control-sm" placeholder="sk-proj..." />
              <div class="form-check">
                <input id="chat-openai-key-show" type="checkbox" class="form-check-input" />
                <label class="form-check-label small" for="chat-openai-key-show">Show</label>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small" for="chat-openai-model">Model</label>
            <select id="chat-openai-model" class="form-select form-select-sm">
              <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
              <option value="gpt-4">GPT-4</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Ollama Settings -->
      <div id="ollama-settings" class="llm-provider-settings" style="display:none">
        <h4 class="small">Ollama Configuration</h4>
        <div class="row g-2" style="max-width:720px; margin-bottom:1rem">
          <div class="col-12 col-md-8">
            <label class="form-label small" for="chat-ollama-url">Ollama URL</label>
            <input id="chat-ollama-url" type="text" class="form-control form-control-sm" placeholder="http://localhost:11434" value="http://localhost:11434" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small" for="chat-ollama-model">Model</label>
            <select id="chat-ollama-model" class="form-select form-select-sm">
              <option value="llama2">Llama 2</option>
              <option value="mistral">Mistral</option>
              <option value="codellama">Code Llama</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top:1rem">
        <button id="chat-save-llm-config" class="btn btn-sm btn-primary">Save LLM Configuration</button>
      </div>

      <h3>Chat Behavior</h3>
      <div class="row g-2" style="max-width:720px">
        <div class="col-12">
          <div class="form-check">
            <input id="chat-verbose-mode" type="checkbox" class="form-check-input" />
            <label class="form-check-label" for="chat-verbose-mode">
              Verbose mode (show technical details like entities, execution time)
            </label>
          </div>
          <small class="form-text text-muted">Can also be toggled per-session in the chat interface.</small>
        </div>
        <div class="col-12" style="margin-top:1rem">
          <button id="chat-save-settings" class="btn btn-sm btn-outline-secondary">Save Settings</button>
        </div>
      </div>

      <details style="margin-top:1.5rem">
        <summary class="small">Advanced</summary>
        <p class="small" style="margin-top:.5rem">
          Environment variables:
          <ul class="small">
            <li><code>SCIDK_ANTHROPIC_API_KEY</code> - Anthropic API key for LLM-enhanced entity extraction</li>
            <li><code>SCIDK_GRAPHRAG_VERBOSE</code> - Set to '1' or 'true' to enable verbose mode by default</li>
          </ul>
        </p>
      </details>

      <h3 style="margin-top:2rem">Chat History</h3>
      <p class="small">Manage chat sessions with persistent database storage.</p>
      <div style="padding:1rem; background:#f9f9f9; border-radius:4px; border:1px solid #e0e0e0">
        <p class="small">
          Chat sessions are now stored in the database and can be:
        </p>
        <ul class="small">
          <li>Saved from the Chat interface using the "Save Session" button</li>
          <li>Loaded from the session selector dropdown</li>
          <li>Managed (rename, export, delete) using the "ðŸ“‚" button</li>
          <li>Exported as JSON files and imported from backups</li>
        </ul>
        <p class="small" style="margin-bottom:0">
          <a href="/chat" class="btn btn-sm btn-outline-primary">Open Chat Interface â†’</a>
        </p>
      </div>
    </section>

    <!-- Interpreters Section -->
    <section id="interpreters-section" class="settings-section">
  <h1>Interpreters</h1>
  <p class="small">Registered interpreter mappings and selection rules.</p>
  <h3 class="small">Mappings (extension â†’ interpreter ids)</h3>
  <ul>
    {% for ext, ids in (mappings or {}).items() %}
      <li><code>{{ ext }}</code> â†’ {{ ids }}</li>
    {% else %}
      <li class="small">No mappings.</li>
    {% endfor %}
  </ul>
  <h3 class="small">Rules</h3>
  <ul>
    {% for r in (rules or []) %}
      <li><code>{{ r.id }}</code> â†’ interpreter_id={{ r.interpreter_id }}, pattern={{ r.pattern }}, priority={{ r.priority }}</li>
    {% else %}
      <li class="small">No rules.</li>
    {% endfor %}
  </ul>

  <h3 style="margin-top:1rem">Interpreter toggles</h3>
  <p class="small">Enable or disable interpreters globally. Changes persist to settings when possible. If CLI env overrides are set (SCIDK_ENABLE_INTERPRETERS/SCIDK_DISABLE_INTERPRETERS), those take precedence and are shown as source=cli.</p>
  <div id="interp-alert" class="small" style="margin:.25rem 0; color:#b00020; display:none">
    Effective view is controlled by CLI env overrides; toggle effects may be masked.
    Unset SCIDK_ENABLE_INTERPRETERS/SCIDK_DISABLE_INTERPRETERS to allow GUI control.
    <div id="interp-env" class="small" style="margin-top:.25rem"></div>
  </div>
  <div style="overflow:auto; max-width: 100%">
    <table id="interp-table">
      <thead>
        <tr>
          <th style="min-width:160px">Interpreter</th>
          <th>Extensions</th>
          <th>Enabled</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    (function(){
      async function fetchEffective(){
        const r = await fetch('/api/interpreters?view=effective');
        if(!r.ok){ toast('Failed to load interpreters', 'error'); return []; }
        return await r.json();
      }
      function render(rows){
        const tb = document.querySelector('#interp-table tbody');
        tb.innerHTML='';
        let src = null;
        rows.forEach(it => {
          if (!src && it.source) src = it.source;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${it.name || it.id}</strong><div class="small">${it.id}</div></td>
            <td class="small">${(it.globs||[]).join(', ')}</td>
            <td>
              <label class="form-check">
                <input type="checkbox" class="form-check-input" ${it.enabled ? 'checked' : ''} data-iid="${it.id}" />
              </label>
            </td>
            <td><span class="badge">${it.source || ''}</span></td>
          `;
          tb.appendChild(tr);
        });
        const alertEl = document.getElementById('interp-alert');
        const envEl = document.getElementById('interp-env');
        if (src === 'cli') {
          alertEl.style.display = 'block';
          // Fetch debug info to show env values
          try {
            fetch('/api/interpreters/effective_debug').then(r => r.json()).then(info => {
              const en = ((info.env || {}).enable_raw || []).join(', ');
              const dis = ((info.env || {}).disable_raw || []).join(', ');
              const unkEn = (((info.env || {}).unknown || {}).enable || []).join(', ');
              const unkDis = (((info.env || {}).unknown || {}).disable || []).join(', ');
              let extra = '';
              if (en || dis) {
                extra += `Env ENABLE=[${en||'none'}], DISABLE=[${dis||'none'}]. `;
              }
              if (unkEn || unkDis) {
                extra += `Unknown ids ignored â†’ enable:[${unkEn||'none'}], disable:[${unkDis||'none'}].`;
              }
              envEl.textContent = extra;
            });
          } catch(e) { /* ignore */ }
        } else {
          alertEl.style.display = 'none';
          envEl.textContent = '';
        }
        // Wire change handlers
        tb.querySelectorAll('input[type=checkbox][data-iid]').forEach(chk => {
          chk.addEventListener('change', async (e) => {
            const iid = e.target.getAttribute('data-iid');
            const enabled = e.target.checked;
            try {
              const resp = await fetch(`/api/interpreters/${encodeURIComponent(iid)}/toggle`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled })
              });
              if (!resp.ok) throw new Error('HTTP ' + resp.status);
              // Refresh to reflect effective state/source
              const eff = await fetchEffective();
              render(eff);
              toast(`Updated ${iid}: ${enabled ? 'enabled' : 'disabled'}`, 'success', 1500);
            } catch (err){
              toast('Failed to update ' + iid + ': ' + err, 'error');
              // revert checkbox
              e.target.checked = !enabled;
            }
          });
        });
      }
      fetchEffective().then(render);
    })();
  </script>
    </section>

    <!-- Plugins Section -->
    <section id="plugins-section" class="settings-section">
  <h1>Plugins</h1>
  <p class="small">Plugin registry summary.</p>
  <ul>
    <li class="small">Registered interpreter count: {{ interp_count or 0 }}</li>
    <li class="small">Extensions mapped: {{ ext_count or 0 }}</li>
  </ul>
    </section>

    <!-- Rclone Section -->
    <section id="rclone-section" class="settings-section">
  <h1>Rclone</h1>
  <p class="small">Configure rclone settings for interpretation and mounts.</p>

  <h2 style="margin-top: 1.5rem;">Interpretation</h2>
  <p class="small">Tune streaming-based interpretation from rclone remotes. For very large scans, consider mounting the remote.</p>
  <div class="row g-2" style="max-width:640px">
    <div class="col-12 col-md-6">
      <label class="form-label small" for="rc-suggest">Suggest-mount threshold (files)</label>
      <input id="rc-suggest" type="number" min="0" step="50" class="form-control form-control-sm" placeholder="400" />
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label small" for="rc-batch">Max files per batch</label>
      <input id="rc-batch" type="number" min="100" max="2000" step="50" class="form-control form-control-sm" placeholder="1000" />
    </div>
    <div class="col-12" style="display:flex; gap:.5rem; align-items:end">
      <button id="rc-save" class="btn btn-sm btn-primary">Save</button>
      <span id="rc-msg" class="small"></span>
    </div>
  </div>

  <h2 style="margin-top: 1.5rem;">Mounts</h2>
  <p class="small">Manage rclone mounts under ./data/mounts.</p>
  <div class="row g-2" style="max-width:780px">
    <div class="col-12 col-md-3">
      <label class="form-label small" for="rc-remote">Remote</label>
      <input id="rc-remote" type="text" class="form-control form-control-sm" placeholder="gdrive:" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small" for="rc-subpath">Subpath (optional)</label>
      <input id="rc-subpath" type="text" class="form-control form-control-sm" placeholder="folder/path" />
    </div>
    <div class="col-8 col-md-3">
      <label class="form-label small" for="rc-name">Name</label>
      <input id="rc-name" type="text" class="form-control form-control-sm" placeholder="my_mount" />
    </div>
    <div class="col-4 col-md-2" style="display:flex; align-items:end; gap:.5rem">
      <div class="form-check">
        <input id="rc-ro" class="form-check-input" type="checkbox" checked />
        <label for="rc-ro" class="form-check-label small">Read-only</label>
      </div>
      <button id="rc-create" class="btn btn-sm btn-primary">Create</button>
    </div>
  </div>
  <div style="margin-top:.5rem">
    <button id="rc-refresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
  </div>
  <table class="table table-sm" style="margin-top:.5rem">
    <thead>
      <tr><th>Name</th><th>Target</th><th>Path</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="rc-table-body">
      <tr><td colspan="5" class="small">No mounts.</td></tr>
    </tbody>
  </table>
  <pre id="rc-logs" class="small" style="max-height:200px; overflow:auto; background:#111; color:#ddd; padding:.5rem"></pre>
  <p class="small text-muted">Note: On Windows, cmount/WinFsp may be required; this UI targets Linux/macOS primarily.</p>
    </section>

    <!-- Integrations Section -->
    <section id="integrations-section" class="settings-section">
  <h1>Integrations</h1>
  <p class="small">Configure integration mappings, API endpoints, and matching options.</p>

  <h2 style="margin-top: 1.5rem;">API Endpoint Mappings</h2>
  <p class="small">Define API endpoints that map to Label types in SciDK.</p>

  <!-- Add Endpoint Form -->
  <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
    <h3 style="margin-top: 0;">Add New Endpoint</h3>
    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
      <div>
        <label for="api-endpoint-name">Name:</label>
        <input type="text" id="api-endpoint-name" class="form-control" placeholder="Users API" data-testid="api-endpoint-name">
      </div>
      <div>
        <label for="api-endpoint-url">URL:</label>
        <input type="text" id="api-endpoint-url" class="form-control" placeholder="https://api.example.com/users" data-testid="api-endpoint-url">
      </div>
      <div>
        <label for="api-endpoint-auth-method">Auth Method:</label>
        <select id="api-endpoint-auth-method" class="form-control" data-testid="api-endpoint-auth-method">
          <option value="none">None</option>
          <option value="bearer">Bearer Token</option>
          <option value="api_key">API Key</option>
        </select>
      </div>
      <div>
        <label for="api-endpoint-auth-value">Auth Value:</label>
        <input type="password" id="api-endpoint-auth-value" class="form-control" placeholder="Optional" data-testid="api-endpoint-auth-value">
      </div>
      <div>
        <label for="api-endpoint-json-path">JSONPath (optional):</label>
        <input type="text" id="api-endpoint-json-path" class="form-control" placeholder="$.data[*]" data-testid="api-endpoint-json-path">
      </div>
      <div>
        <label for="api-endpoint-target-label">Maps to Label (optional):</label>
        <select id="api-endpoint-target-label" class="form-control" data-testid="api-endpoint-target-label">
          <option value="">-- Select Label --</option>
        </select>
      </div>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button id="btn-test-api-endpoint" class="btn btn-sm btn-outline-primary" data-testid="btn-test-api-endpoint">Test Connection</button>
      <button id="btn-save-api-endpoint" class="btn btn-sm btn-primary" data-testid="btn-save-api-endpoint">Save Endpoint</button>
      <button id="btn-cancel-api-endpoint" class="btn btn-sm btn-outline-secondary" style="display: none;" data-testid="btn-cancel-api-endpoint">Cancel</button>
    </div>
    <div id="api-endpoint-message" class="small" style="margin-top: 0.5rem; color: var(--accent);"></div>
  </div>

  <!-- Endpoints List -->
  <h3>Registered Endpoints</h3>
  <div id="api-endpoints-list">
    <p class="small" style="color: #999;"><em>No endpoints registered yet</em></p>
  </div>

  <h2 style="margin-top: 1.5rem;">Table Format Registry</h2>
  <p class="small">Manage table formats for importing CSV, TSV, Excel, and Parquet files as link sources.</p>

  <!-- Add Format Form -->
  <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
    <h3 style="margin-top: 0;">Add Custom Format</h3>
    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
      <div>
        <label for="table-format-name">Name:</label>
        <input type="text" id="table-format-name" class="form-control" placeholder="My CSV Format" data-testid="table-format-name">
      </div>
      <div>
        <label for="table-format-file-type">File Type:</label>
        <select id="table-format-file-type" class="form-control" data-testid="table-format-file-type">
          <option value="csv">CSV</option>
          <option value="tsv">TSV</option>
          <option value="excel">Excel</option>
          <option value="parquet">Parquet</option>
        </select>
      </div>
      <div>
        <label for="table-format-delimiter">Delimiter:</label>
        <input type="text" id="table-format-delimiter" class="form-control" placeholder="," maxlength="1" data-testid="table-format-delimiter">
      </div>
      <div>
        <label for="table-format-encoding">Encoding:</label>
        <select id="table-format-encoding" class="form-control" data-testid="table-format-encoding">
          <option value="utf-8">UTF-8</option>
          <option value="latin-1">Latin-1</option>
          <option value="utf-16">UTF-16</option>
        </select>
      </div>
      <div>
        <label for="table-format-target-label">Target Label (optional):</label>
        <select id="table-format-target-label" class="form-control" data-testid="table-format-target-label">
          <option value="">-- Select Label --</option>
        </select>
      </div>
      <div style="display: flex; align-items: end; gap: 0.5rem;">
        <div class="form-check">
          <input id="table-format-has-header" class="form-check-input" type="checkbox" checked data-testid="table-format-has-header">
          <label for="table-format-has-header" class="form-check-label small">Has Header Row</label>
        </div>
      </div>
    </div>
    <div>
      <label for="table-format-description">Description (optional):</label>
      <input type="text" id="table-format-description" class="form-control" placeholder="Custom format for..." data-testid="table-format-description">
    </div>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
      <button id="btn-save-table-format" class="btn btn-sm btn-primary" data-testid="btn-save-table-format">Save Format</button>
      <button id="btn-cancel-table-format" class="btn btn-sm btn-outline-secondary" style="display: none;" data-testid="btn-cancel-table-format">Cancel</button>
      <label class="btn btn-sm btn-outline-secondary" for="table-format-upload-sample">
        <input type="file" id="table-format-upload-sample" style="display: none;" accept=".csv,.tsv,.txt,.xlsx,.xls,.parquet" data-testid="table-format-upload-sample">
        Upload Sample & Detect
      </label>
    </div>
    <div id="table-format-message" class="small" style="margin-top: 0.5rem; color: var(--accent);"></div>

    <!-- Preview Section -->
    <div id="table-format-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
      <h4>Data Preview</h4>
      <div id="table-format-preview-content"></div>
    </div>
  </div>

  <!-- Formats List -->
  <h3>Registered Formats</h3>
  <div id="table-formats-list">
    <p class="small" style="color: #999;"><em>Loading formats...</em></p>
  </div>

  <h2 style="margin-top: 1.5rem;">Fuzzy Matching Options</h2>
  <p class="small">Configure fuzzy matching algorithms for entity resolution in link creation.</p>

  <!-- Fuzzy Matching Settings Form -->
  <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 4px; max-width: 800px;">
    <h3 style="margin-top: 0;">Global Fuzzy Matching Settings</h3>

    <!-- Primary Settings -->
    <div class="row g-2" style="margin-bottom: 1rem;">
      <div class="col-12 col-md-6">
        <label class="form-label small" for="fuzzy-algorithm">Matching Algorithm:</label>
        <select id="fuzzy-algorithm" class="form-control form-control-sm" data-testid="fuzzy-algorithm">
          <option value="exact">Exact Match</option>
          <option value="levenshtein">Levenshtein Distance</option>
          <option value="jaro_winkler">Jaro-Winkler Distance</option>
          <option value="phonetic">Phonetic (Soundex/Metaphone)</option>
        </select>
        <div class="small text-muted">Levenshtein: general fuzzy matching | Jaro-Winkler: names | Phonetic: sound-alike</div>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label small" for="fuzzy-threshold">Similarity Threshold: <span id="fuzzy-threshold-value">80</span>%</label>
        <input id="fuzzy-threshold" type="range" class="form-range" min="0" max="100" value="80" data-testid="fuzzy-threshold">
        <div class="small text-muted">Minimum similarity score (0-100%) to consider a match</div>
      </div>
    </div>

    <!-- Normalization Options -->
    <div class="row g-2" style="margin-bottom: 1rem;">
      <div class="col-12 col-md-4">
        <div class="form-check">
          <input id="fuzzy-case-sensitive" class="form-check-input" type="checkbox" data-testid="fuzzy-case-sensitive">
          <label class="form-check-label small" for="fuzzy-case-sensitive">Case Sensitive</label>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="form-check">
          <input id="fuzzy-normalize-whitespace" class="form-check-input" type="checkbox" checked data-testid="fuzzy-normalize-whitespace">
          <label class="form-check-label small" for="fuzzy-normalize-whitespace">Normalize Whitespace</label>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="form-check">
          <input id="fuzzy-strip-punctuation" class="form-check-input" type="checkbox" checked data-testid="fuzzy-strip-punctuation">
          <label class="form-check-label small" for="fuzzy-strip-punctuation">Strip Punctuation</label>
        </div>
      </div>
    </div>

    <!-- Phonetic Settings (shown when algorithm is phonetic) -->
    <div id="fuzzy-phonetic-settings" style="display: none; margin-bottom: 1rem;">
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <div class="form-check">
            <input id="fuzzy-phonetic-enabled" class="form-check-input" type="checkbox" data-testid="fuzzy-phonetic-enabled">
            <label class="form-check-label small" for="fuzzy-phonetic-enabled">Enable Phonetic Matching</label>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label small" for="fuzzy-phonetic-algorithm">Phonetic Algorithm:</label>
          <select id="fuzzy-phonetic-algorithm" class="form-control form-control-sm" data-testid="fuzzy-phonetic-algorithm">
            <option value="soundex">Soundex</option>
            <option value="metaphone">Metaphone (Better)</option>
            <option value="double_metaphone">Double Metaphone</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Advanced Settings (Collapsible) -->
    <details style="margin-bottom: 1rem;">
      <summary class="small" style="cursor: pointer;">Advanced Options</summary>
      <div class="row g-2" style="margin-top: 0.5rem;">
        <div class="col-12 col-md-4">
          <label class="form-label small" for="fuzzy-min-length">Min String Length:</label>
          <input id="fuzzy-min-length" type="number" class="form-control form-control-sm" min="1" max="10" value="3" data-testid="fuzzy-min-length">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small" for="fuzzy-max-comparisons">Max Comparisons:</label>
          <input id="fuzzy-max-comparisons" type="number" class="form-control form-control-sm" min="100" max="100000" step="100" value="10000" data-testid="fuzzy-max-comparisons">
        </div>
        <div class="col-12 col-md-4" style="display: flex; align-items: end;">
          <div class="form-check">
            <input id="fuzzy-show-confidence" class="form-check-input" type="checkbox" checked data-testid="fuzzy-show-confidence">
            <label class="form-check-label small" for="fuzzy-show-confidence">Show Confidence Scores</label>
          </div>
        </div>
      </div>
    </details>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 0.5rem;">
      <button id="btn-save-fuzzy-settings" class="btn btn-sm btn-primary" data-testid="btn-save-fuzzy-settings">Save Settings</button>
      <button id="btn-reset-fuzzy-settings" class="btn btn-sm btn-outline-secondary" data-testid="btn-reset-fuzzy-settings">Reset to Defaults</button>
    </div>
    <div id="fuzzy-settings-message" class="small" style="margin-top: 0.5rem; color: var(--accent);"></div>
  </div>

  <!-- Architecture Info -->
  <div style="padding: 1rem; background: #f0f8ff; border-left: 3px solid #19c37d; margin-bottom: 1rem; max-width: 800px;">
    <h4 class="small" style="margin-top: 0;">Hybrid Matching Architecture</h4>
    <p class="small" style="margin-bottom: 0.5rem;">
      <strong>Phase 1 (Client-Side):</strong> Pre-import matching using rapidfuzz - match external API/CSV data before pushing to Neo4j.
    </p>
    <p class="small" style="margin: 0;">
      <strong>Phase 2 (Server-Side):</strong> Post-import matching using Neo4j APOC functions - ultra-fast in-database entity resolution for existing nodes.
    </p>
  </div>
    </section>
  </div>
</div>

<script>
  // Settings navigation
  document.addEventListener('DOMContentLoaded', () => {
    const navItems = document.querySelectorAll('.settings-sidebar-item');
    const sections = document.querySelectorAll('.settings-section');

    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();

        // Update active nav item
        navItems.forEach(nav => nav.classList.remove('active'));
        item.classList.add('active');

        // Show corresponding section
        const sectionId = item.dataset.section + '-section';
        sections.forEach(section => section.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');

        // Update URL hash without scrolling
        history.replaceState(null, null, '#' + item.dataset.section);
      });
    });

    // Handle initial hash navigation
    const hash = window.location.hash.slice(1);
    if (hash) {
      const targetNav = document.querySelector(`[data-section="${hash}"]`);
      if (targetNav) {
        targetNav.click();
      }
    }
  });
</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-test-graph');

    // Rclone Interpretation settings
    const rcSuggest = document.getElementById('rc-suggest');
    const rcBatch = document.getElementById('rc-batch');
    const rcSave = document.getElementById('rc-save');
    const rcMsg = document.getElementById('rc-msg');
    async function loadRcloneInterp(){
      try { const r = await fetch('/api/settings/rclone-interpret'); const j = await r.json(); if (rcSuggest) rcSuggest.value = (j.suggest_mount_threshold ?? 400); if (rcBatch) rcBatch.value = (j.max_files_per_batch ?? 1000); }
      catch(e){ if (rcMsg) rcMsg.textContent = 'Failed to load: ' + e; }
    }
    async function saveRcloneInterp(){
      const payload = { suggest_mount_threshold: Number(rcSuggest && rcSuggest.value || 400), max_files_per_batch: Number(rcBatch && rcBatch.value || 1000) };
      try { const r = await fetch('/api/settings/rclone-interpret', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); const j = await r.json(); if (!r.ok) { rcMsg.textContent = 'Save failed: ' + (j.error || r.status); } else { rcMsg.textContent = 'Saved.'; setTimeout(()=>{rcMsg.textContent='';},1500); } }
      catch(e){ rcMsg.textContent = 'Save failed: ' + e; }
    }
    if (rcSave) rcSave.addEventListener('click', async (e) => { e.preventDefault(); await saveRcloneInterp(); });
    loadRcloneInterp();

    // Rclone mounts UI bindings
    const rcEnabled = {{ 'true' if rclone_mounts_feature else 'false' }};
    const elRemote = document.getElementById('rc-remote');
    const elSub = document.getElementById('rc-subpath');
    const elName = document.getElementById('rc-name');
    const elRO = document.getElementById('rc-ro');
    const btnCreate = document.getElementById('rc-create');
    const btnRefresh = document.getElementById('rc-refresh');
    const tblBody = document.getElementById('rc-table-body');
    const logsBox = document.getElementById('rc-logs');

    async function refreshMounts(){
      if (!rcEnabled || !tblBody) return;
      try {
        const r = await fetch('/api/rclone/mounts');
        const j = await r.json();
        tblBody.innerHTML = '';
        if (!Array.isArray(j) || j.length === 0){
          tblBody.innerHTML = '<tr><td colspan="5" class="small">No mounts.</td></tr>';
          return;
        }
        for (const m of j){
          const tr = document.createElement('tr');
          const target = (m.remote || '') + (m.subpath || '');
          tr.innerHTML = `<td>${m.name||m.id}</td><td>${target}</td><td>${m.path||''}</td><td>${m.status||''}</td>`;
          const tdAct = document.createElement('td');
          const btnLogs = document.createElement('button'); btnLogs.textContent = 'Logs'; btnLogs.className = 'btn btn-sm btn-outline-secondary';
          btnLogs.addEventListener('click', async () => {
            logsBox.textContent = 'Loading logs...';
            const r2 = await fetch(`/api/rclone/mounts/${encodeURIComponent(m.id)}/logs?tail=200`);
            const j2 = await r2.json();
            logsBox.textContent = (j2.lines||[]).join('\n');
          });
          const btnDel = document.createElement('button'); btnDel.textContent = 'Unmount'; btnDel.className = 'btn btn-sm btn-outline-danger'; btnDel.style.marginLeft = '.25rem';
          btnDel.addEventListener('click', async () => {
            if (!confirm('Unmount ' + (m.name||m.id) + '?')) return;
            const r3 = await fetch(`/api/rclone/mounts/${encodeURIComponent(m.id)}`, { method:'DELETE' });
            await refreshMounts();
          });
          tdAct.appendChild(btnLogs); tdAct.appendChild(btnDel);
          tr.appendChild(tdAct);
          tblBody.appendChild(tr);
        }
      } catch(e){ /* ignore */ }
    }
    async function createMount(){
      if (!rcEnabled || !btnCreate) return;
      try {
        const payload = { remote: (elRemote && elRemote.value)||'', subpath: (elSub && elSub.value)||'', name: (elName && elName.value)||'', read_only: elRO && elRO.checked };
        const r = await fetch('/api/rclone/mounts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await r.json();
        if (!r.ok){ alert('Create failed: ' + (j.error || r.status)); return; }
        elName && (elName.value = '');
        await refreshMounts();
      } catch(e) { alert('Create failed: ' + e); }
    }
    if (btnCreate) btnCreate.addEventListener('click', async (e) => { e.preventDefault(); await createMount(); });
    if (btnRefresh) btnRefresh.addEventListener('click', async (e) => { e.preventDefault(); await refreshMounts(); });
    refreshMounts();
    const status = document.getElementById('graph-health-status');
    async function testGraph(){
      status.textContent = 'Checking...';
      try {
        const r = await fetch('/api/health/graph');
        const j = await r.json();
        if (!r.ok){ status.textContent = 'Error: ' + (j.error || r.status); return; }
        const neo = j.neo4j || {};
        const parts = [
          `backend=${j.backend}`,
          `in_memory_ok=${j.in_memory_ok}`,
          `neo4j_configured=${neo.configured}`,
          `neo4j_connectable=${neo.connectable}`
        ];
        if (neo.error) parts.push('neo4j_error=' + neo.error);
        status.textContent = parts.join(' â€” ');
      } catch(e){
        status.textContent = 'Health check failed: ' + (e && e.message ? e.message : e);
      }
    }
    if (btn) btn.addEventListener('click', testGraph);

    // Neo4j settings UI
    const elUri = document.getElementById('neo4j-uri');
    const elUser = document.getElementById('neo4j-user');
    const elDb = document.getElementById('neo4j-db');
    const elPass = document.getElementById('neo4j-pass');
    const elShow = document.getElementById('neo4j-pass-show');
    const btnSave = document.getElementById('neo4j-save');
    const btnConn = document.getElementById('neo4j-connect');
    const btnDisc = document.getElementById('neo4j-disconnect');
    const light = document.getElementById('neo4j-light');
    const statusText = document.getElementById('neo4j-status-text');

    if (elShow) elShow.addEventListener('change', () => {
      elPass.type = elShow.checked ? 'text' : 'password';
    });

    function setLight(ok){
      if (!light) return;
      light.style.background = ok ? '#19c37d' : '#000';
      light.title = ok ? 'Connected' : 'Disconnected';
    }
    function setButtons(ok){
      if (btnConn) btnConn.style.display = ok ? 'none' : '';
      if (btnDisc) btnDisc.style.display = ok ? '' : 'none';
    }
    function renderStatus(j){
      setLight(!!j.connected);
      setButtons(!!j.connected);
      statusText.textContent = j.error ? ('Error: ' + j.error) : (j.connected ? 'Connected' : 'Not connected');
    }

    async function loadCfg(){
      try {
        const r = await fetch('/api/settings/neo4j');
        const j = await r.json();
        if (elUri) elUri.value = j.uri || '';
        if (elUser) elUser.value = j.user || '';
        if (elDb) elDb.value = j.database || '';
        setLight(!!j.connected);
        setButtons(!!j.connected);
        statusText.textContent = j.connected ? 'Connected' : (j.last_error ? ('Error: ' + j.last_error) : 'Not connected');
      } catch(e) {
        statusText.textContent = 'Failed to load settings';
      }
    }

    async function saveCfg(){
      const payload = {
        uri: (elUri && elUri.value) || '',
        user: (elUser && elUser.value) || '',
        // Only send password if non-empty to avoid clearing stored secret unintentionally
        ...(elPass && elPass.value ? { password: elPass.value } : {}),
        database: (elDb && elDb.value) || ''
      };
      try {
        const r = await fetch('/api/settings/neo4j', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if (!r.ok){ const j = await r.json(); alert('Save failed: ' + (j.error || r.status)); return; }
        // Clear password field in UI after save
        if (elPass) elPass.value = '';
      } catch(e){ alert('Save failed: ' + e); }
    }

    async function connect(){
      try {
        const r = await fetch('/api/settings/neo4j/connect', { method: 'POST' });
        const j = await r.json();
        renderStatus(j);
      } catch(e) {
        statusText.textContent = 'Connect failed';
      }
    }
    async function disconnect(){
      try {
        const r = await fetch('/api/settings/neo4j/disconnect', { method: 'POST' });
        const j = await r.json();
        renderStatus(j);
      } catch(e) {
        statusText.textContent = 'Disconnect failed';
      }
    }

    if (btnSave) btnSave.addEventListener('click', async (e) => { e.preventDefault(); await saveCfg(); });
    if (btnConn) btnConn.addEventListener('click', async (e) => { e.preventDefault(); await saveCfg(); await connect(); });
    if (btnDisc) btnDisc.addEventListener('click', async (e) => { e.preventDefault(); await disconnect(); });

    // Optional: clear stored password explicitly
    const btnClear = document.getElementById('neo4j-clear-pass');
    if (btnClear) btnClear.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const r = await fetch('/api/settings/neo4j', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ clear_password: true }) });
        if (!r.ok){ const j = await r.json(); alert('Clear failed: ' + (j.error || r.status)); return; }
        if (elPass) elPass.value = '';
        alert('Password cleared in server settings.');
      } catch(err){ alert('Clear failed: ' + err); }
    });

    loadCfg();
  });

  // API Endpoint Management
  function initAPIEndpoints() {
    let editingEndpointId = null;
    const nameInput = document.getElementById('api-endpoint-name');
    const urlInput = document.getElementById('api-endpoint-url');
    const authMethodSelect = document.getElementById('api-endpoint-auth-method');
    const authValueInput = document.getElementById('api-endpoint-auth-value');
    const jsonPathInput = document.getElementById('api-endpoint-json-path');
    const targetLabelSelect = document.getElementById('api-endpoint-target-label');
    const btnTest = document.getElementById('btn-test-api-endpoint');
    const btnSave = document.getElementById('btn-save-api-endpoint');
    const btnCancel = document.getElementById('btn-cancel-api-endpoint');
    const messageDiv = document.getElementById('api-endpoint-message');
    const endpointsList = document.getElementById('api-endpoints-list');

    async function loadLabels() {
      try {
        const response = await fetch('/api/labels');
        const data = await response.json();
        if (data.status === 'success' && data.labels) {
          targetLabelSelect.innerHTML = '<option value="">-- Select Label --</option>';
          data.labels.forEach(label => {
            const option = document.createElement('option');
            option.value = label.name;
            option.textContent = label.name;
            targetLabelSelect.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Failed to load labels:', err);
      }
    }

    async function loadEndpoints() {
      try {
        const response = await fetch('/api/settings/api-endpoints');
        const data = await response.json();

        if (data.status === 'success' && data.endpoints && data.endpoints.length > 0) {
          endpointsList.innerHTML = `
            <table class="table table-sm" style="width: 100%;">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>URL</th>
                  <th>Auth</th>
                  <th>Label</th>
                  <th style="width: 180px;">Actions</th>
                </tr>
              </thead>
              <tbody id="endpoints-table-body">
              </tbody>
            </table>
          `;

          const tbody = document.getElementById('endpoints-table-body');
          data.endpoints.forEach(endpoint => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHtml(endpoint.name)}</td>
              <td><span class="small text-muted">${escapeHtml(endpoint.url.substring(0, 40))}${endpoint.url.length > 40 ? '...' : ''}</span></td>
              <td><span class="badge">${endpoint.auth_method}</span></td>
              <td>${endpoint.target_label ? escapeHtml(endpoint.target_label) : '<span class="text-muted">â€”</span>'}</td>
              <td>
                <button class="btn btn-xs btn-outline-primary" onclick="apiEndpointsTestById('${endpoint.id}')">Test</button>
                <button class="btn btn-xs btn-outline-secondary" onclick="apiEndpointsEdit('${endpoint.id}')">Edit</button>
                <button class="btn btn-xs btn-outline-danger" onclick="apiEndpointsDelete('${endpoint.id}')">Delete</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          endpointsList.innerHTML = '<p class="small" style="color: #999;"><em>No endpoints registered yet</em></p>';
        }
      } catch (err) {
        messageDiv.textContent = 'Failed to load endpoints: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    function resetForm() {
      editingEndpointId = null;
      nameInput.value = '';
      urlInput.value = '';
      authMethodSelect.value = 'none';
      authValueInput.value = '';
      jsonPathInput.value = '';
      targetLabelSelect.value = '';
      btnSave.textContent = 'Save Endpoint';
      btnCancel.style.display = 'none';
      messageDiv.textContent = '';
    }

    async function testEndpoint() {
      const name = nameInput.value.trim();
      const url = urlInput.value.trim();

      if (!name || !url) {
        messageDiv.textContent = 'Name and URL are required';
        messageDiv.style.color = 'red';
        return;
      }

      // Create temporary endpoint for testing
      const tempData = {
        name: name + '_test_' + Date.now(),
        url: url,
        auth_method: authMethodSelect.value,
        auth_value: authValueInput.value.trim(),
        json_path: jsonPathInput.value.trim()
      };

      try {
        messageDiv.textContent = 'Creating test endpoint...';
        messageDiv.style.color = '#666';

        // Create temporary endpoint
        const createResp = await fetch('/api/settings/api-endpoints', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tempData)
        });

        if (!createResp.ok) {
          const errorData = await createResp.json();
          throw new Error(errorData.error || 'Failed to create test endpoint');
        }

        const createData = await createResp.json();
        const tempId = createData.endpoint.id;

        // Test the endpoint
        messageDiv.textContent = 'Testing connection...';
        const testResp = await fetch(`/api/settings/api-endpoints/${tempId}/test`, {
          method: 'POST'
        });

        const testData = await testResp.json();

        // Delete temporary endpoint
        await fetch(`/api/settings/api-endpoints/${tempId}`, { method: 'DELETE' });

        if (testData.status === 'success' && testData.test_result) {
          const result = testData.test_result;
          if (result.success) {
            messageDiv.textContent = `âœ“ Connection successful! Found ${result.total_records} records. Sample: ${JSON.stringify(result.sample_data[0] || {}).substring(0, 100)}...`;
            messageDiv.style.color = 'green';
          } else {
            messageDiv.textContent = `âœ— Test failed: ${result.error}`;
            messageDiv.style.color = 'red';
          }
        } else {
          throw new Error('Invalid test response');
        }
      } catch (err) {
        messageDiv.textContent = 'âœ— Test failed: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    async function saveEndpoint() {
      const name = nameInput.value.trim();
      const url = urlInput.value.trim();

      if (!name || !url) {
        messageDiv.textContent = 'Name and URL are required';
        messageDiv.style.color = 'red';
        return;
      }

      const endpointData = {
        name: name,
        url: url,
        auth_method: authMethodSelect.value,
        auth_value: authValueInput.value.trim(),
        json_path: jsonPathInput.value.trim(),
        target_label: targetLabelSelect.value
      };

      try {
        let response;
        if (editingEndpointId) {
          // Update existing
          response = await fetch(`/api/settings/api-endpoints/${editingEndpointId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(endpointData)
          });
        } else {
          // Create new
          response = await fetch('/api/settings/api-endpoints', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(endpointData)
          });
        }

        const data = await response.json();

        if (data.status === 'success') {
          messageDiv.textContent = editingEndpointId ? 'Endpoint updated!' : 'Endpoint saved!';
          messageDiv.style.color = 'green';
          resetForm();
          await loadEndpoints();
          setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        } else {
          messageDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
          messageDiv.style.color = 'red';
        }
      } catch (err) {
        messageDiv.textContent = 'Save failed: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    // Global functions for onclick handlers
    window.apiEndpointsEdit = async function(id) {
      try {
        const response = await fetch(`/api/settings/api-endpoints/${id}`);
        const data = await response.json();

        if (data.status === 'success' && data.endpoint) {
          const endpoint = data.endpoint;
          editingEndpointId = id;
          nameInput.value = endpoint.name;
          urlInput.value = endpoint.url;
          authMethodSelect.value = endpoint.auth_method;
          // Note: auth_value is not returned for security
          authValueInput.value = '';
          authValueInput.placeholder = 'Enter new value or leave empty to keep existing';
          jsonPathInput.value = endpoint.json_path || '';
          targetLabelSelect.value = endpoint.target_label || '';
          btnSave.textContent = 'Update Endpoint';
          btnCancel.style.display = 'inline-block';
          messageDiv.textContent = 'Editing: ' + endpoint.name;
          messageDiv.style.color = '#666';

          // Scroll to form
          nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        alert('Failed to load endpoint: ' + err.message);
      }
    };

    window.apiEndpointsDelete = async function(id) {
      if (!confirm('Are you sure you want to delete this endpoint?')) {
        return;
      }

      try {
        const response = await fetch(`/api/settings/api-endpoints/${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.status === 'success') {
          await loadEndpoints();
          messageDiv.textContent = 'Endpoint deleted';
          messageDiv.style.color = 'green';
          setTimeout(() => { messageDiv.textContent = ''; }, 2000);
        } else {
          alert('Delete failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    };

    window.apiEndpointsTestById = async function(id) {
      try {
        messageDiv.textContent = 'Testing connection...';
        messageDiv.style.color = '#666';

        const response = await fetch(`/api/settings/api-endpoints/${id}/test`, {
          method: 'POST'
        });
        const data = await response.json();

        if (data.status === 'success' && data.test_result) {
          const result = data.test_result;
          if (result.success) {
            messageDiv.textContent = `âœ“ Connection successful! Found ${result.total_records} records.`;
            messageDiv.style.color = 'green';
          } else {
            messageDiv.textContent = `âœ— Test failed: ${result.error}`;
            messageDiv.style.color = 'red';
          }
        } else {
          messageDiv.textContent = 'âœ— Test failed: ' + (data.error || 'Unknown error');
          messageDiv.style.color = 'red';
        }

        setTimeout(() => { messageDiv.textContent = ''; }, 5000);
      } catch (err) {
        messageDiv.textContent = 'âœ— Test failed: ' + err.message;
        messageDiv.style.color = 'red';
        setTimeout(() => { messageDiv.textContent = ''; }, 5000);
      }
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (btnTest) btnTest.addEventListener('click', testEndpoint);
    if (btnSave) btnSave.addEventListener('click', saveEndpoint);
    if (btnCancel) btnCancel.addEventListener('click', resetForm);

    // Load labels and endpoints on page load
    loadLabels();
    loadEndpoints();
  }

  // Initialize immediately if DOM is ready, otherwise wait for DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAPIEndpoints);
  } else {
    initAPIEndpoints();
  }

  // Table Format Registry Management
  function initTableFormats() {
    let editingFormatId = null;
    const nameInput = document.getElementById('table-format-name');
    const fileTypeSelect = document.getElementById('table-format-file-type');
    const delimiterInput = document.getElementById('table-format-delimiter');
    const encodingSelect = document.getElementById('table-format-encoding');
    const targetLabelSelect = document.getElementById('table-format-target-label');
    const hasHeaderCheck = document.getElementById('table-format-has-header');
    const descriptionInput = document.getElementById('table-format-description');
    const btnSave = document.getElementById('btn-save-table-format');
    const btnCancel = document.getElementById('btn-cancel-table-format');
    const uploadSample = document.getElementById('table-format-upload-sample');
    const messageDiv = document.getElementById('table-format-message');
    const formatsList = document.getElementById('table-formats-list');
    const previewDiv = document.getElementById('table-format-preview');
    const previewContent = document.getElementById('table-format-preview-content');

    // Update delimiter placeholder based on file type
    fileTypeSelect.addEventListener('change', () => {
      const fileType = fileTypeSelect.value;
      if (fileType === 'csv') {
        delimiterInput.value = ',';
        delimiterInput.disabled = false;
      } else if (fileType === 'tsv') {
        delimiterInput.value = '\t';
        delimiterInput.disabled = false;
      } else {
        delimiterInput.value = '';
        delimiterInput.disabled = true;
      }
    });

    async function loadLabels() {
      try {
        const response = await fetch('/api/labels');
        const data = await response.json();
        if (data.status === 'success' && data.labels) {
          targetLabelSelect.innerHTML = '<option value="">-- Select Label --</option>';
          data.labels.forEach(label => {
            const option = document.createElement('option');
            option.value = label.name;
            option.textContent = label.name;
            targetLabelSelect.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Failed to load labels:', err);
      }
    }

    async function loadFormats() {
      try {
        const response = await fetch('/api/settings/table-formats');
        const data = await response.json();

        if (data.status === 'success' && data.formats && data.formats.length > 0) {
          formatsList.innerHTML = `
            <table class="table table-sm" style="width: 100%;">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Delimiter</th>
                  <th>Encoding</th>
                  <th>Target Label</th>
                  <th style="width: 180px;">Actions</th>
                </tr>
              </thead>
              <tbody id="formats-table-body">
              </tbody>
            </table>
          `;

          const tbody = document.getElementById('formats-table-body');
          data.formats.forEach(format => {
            const row = document.createElement('tr');
            const badge = format.is_preprogrammed ? '<span class="badge" style="background: #19c37d; color: white; margin-left: 0.25rem;">Preprogrammed</span>' : '';
            row.innerHTML = `
              <td>${escapeHtml(format.name)}${badge}</td>
              <td><span class="badge">${format.file_type.toUpperCase()}</span></td>
              <td><span class="small text-muted">${format.delimiter || 'â€”'}</span></td>
              <td><span class="small text-muted">${format.encoding}</span></td>
              <td>${format.target_label ? escapeHtml(format.target_label) : '<span class="text-muted">â€”</span>'}</td>
              <td>
                ${!format.is_preprogrammed ? `
                  <button class="btn btn-xs btn-outline-secondary" onclick="tableFormatsEdit('${format.id}')">Edit</button>
                  <button class="btn btn-xs btn-outline-danger" onclick="tableFormatsDelete('${format.id}')">Delete</button>
                ` : '<span class="small text-muted">Read-only</span>'}
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          formatsList.innerHTML = '<p class="small" style="color: #999;"><em>No formats registered yet</em></p>';
        }
      } catch (err) {
        messageDiv.textContent = 'Failed to load formats: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    function resetForm() {
      editingFormatId = null;
      nameInput.value = '';
      fileTypeSelect.value = 'csv';
      delimiterInput.value = ',';
      delimiterInput.disabled = false;
      encodingSelect.value = 'utf-8';
      targetLabelSelect.value = '';
      hasHeaderCheck.checked = true;
      descriptionInput.value = '';
      btnSave.textContent = 'Save Format';
      btnCancel.style.display = 'none';
      messageDiv.textContent = '';
      previewDiv.style.display = 'none';
    }

    async function saveFormat() {
      const name = nameInput.value.trim();
      const fileType = fileTypeSelect.value;

      if (!name) {
        messageDiv.textContent = 'Name is required';
        messageDiv.style.color = 'red';
        return;
      }

      const formatData = {
        name: name,
        file_type: fileType,
        delimiter: delimiterInput.value || null,
        encoding: encodingSelect.value,
        has_header: hasHeaderCheck.checked,
        header_row: hasHeaderCheck.checked ? 0 : null,
        target_label: targetLabelSelect.value || null,
        description: descriptionInput.value.trim() || null
      };

      try {
        let response;
        if (editingFormatId) {
          response = await fetch(`/api/settings/table-formats/${editingFormatId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formatData)
          });
        } else {
          response = await fetch('/api/settings/table-formats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formatData)
          });
        }

        const data = await response.json();

        if (data.status === 'success') {
          messageDiv.textContent = editingFormatId ? 'Format updated!' : 'Format saved!';
          messageDiv.style.color = 'green';
          resetForm();
          await loadFormats();
          setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        } else {
          messageDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
          messageDiv.style.color = 'red';
        }
      } catch (err) {
        messageDiv.textContent = 'Save failed: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    // Handle file upload for auto-detect
    uploadSample.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      messageDiv.textContent = 'Detecting format...';
      messageDiv.style.color = '#666';

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/settings/table-formats/detect', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        if (data.status === 'success' && data.detected) {
          const detected = data.detected;

          // Update form fields
          if (!nameInput.value) {
            nameInput.value = file.name.split('.')[0] + ' Format';
          }
          fileTypeSelect.value = detected.file_type;
          fileTypeSelect.dispatchEvent(new Event('change'));
          if (detected.delimiter) {
            delimiterInput.value = detected.delimiter;
          }
          encodingSelect.value = detected.encoding;
          hasHeaderCheck.checked = detected.has_header;

          // Show detected columns
          if (detected.sample_columns && detected.sample_columns.length > 0) {
            previewContent.innerHTML = `
              <p class="small"><strong>Detected columns:</strong> ${detected.sample_columns.join(', ')}</p>
            `;
            previewDiv.style.display = 'block';
          }

          messageDiv.textContent = 'âœ“ Format detected! Review and save.';
          messageDiv.style.color = 'green';
        } else {
          messageDiv.textContent = 'âœ— Detection failed: ' + (data.error || 'Unknown error');
          messageDiv.style.color = 'red';
        }
      } catch (err) {
        messageDiv.textContent = 'âœ— Detection failed: ' + err.message;
        messageDiv.style.color = 'red';
      }

      // Reset file input
      e.target.value = '';
    });

    // Global functions for onclick handlers
    window.tableFormatsEdit = async function(id) {
      try {
        const response = await fetch(`/api/settings/table-formats/${id}`);
        const data = await response.json();

        if (data.status === 'success' && data.format) {
          const format = data.format;
          editingFormatId = id;
          nameInput.value = format.name;
          fileTypeSelect.value = format.file_type;
          delimiterInput.value = format.delimiter || '';
          encodingSelect.value = format.encoding;
          targetLabelSelect.value = format.target_label || '';
          hasHeaderCheck.checked = format.has_header;
          descriptionInput.value = format.description || '';
          btnSave.textContent = 'Update Format';
          btnCancel.style.display = 'inline-block';
          messageDiv.textContent = 'Editing: ' + format.name;
          messageDiv.style.color = '#666';

          // Scroll to form
          nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        alert('Failed to load format: ' + err.message);
      }
    };

    window.tableFormatsDelete = async function(id) {
      if (!confirm('Are you sure you want to delete this format?')) {
        return;
      }

      try {
        const response = await fetch(`/api/settings/table-formats/${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.status === 'success') {
          await loadFormats();
          messageDiv.textContent = 'Format deleted';
          messageDiv.style.color = 'green';
          setTimeout(() => { messageDiv.textContent = ''; }, 2000);
        } else {
          alert('Delete failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (btnSave) btnSave.addEventListener('click', saveFormat);
    if (btnCancel) btnCancel.addEventListener('click', resetForm);

    // Initialize delimiter on page load
    fileTypeSelect.dispatchEvent(new Event('change'));

    // Load labels and formats
    loadLabels();
    loadFormats();
  }

  // Initialize table formats immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTableFormats);
  } else {
    initTableFormats();
  }

  // Fuzzy Matching Settings Management
  function initFuzzyMatching() {
    const algorithmSelect = document.getElementById('fuzzy-algorithm');
    const thresholdInput = document.getElementById('fuzzy-threshold');
    const thresholdValue = document.getElementById('fuzzy-threshold-value');
    const caseSensitiveCheck = document.getElementById('fuzzy-case-sensitive');
    const normalizeWhitespaceCheck = document.getElementById('fuzzy-normalize-whitespace');
    const stripPunctuationCheck = document.getElementById('fuzzy-strip-punctuation');
    const phoneticSettings = document.getElementById('fuzzy-phonetic-settings');
    const phoneticEnabledCheck = document.getElementById('fuzzy-phonetic-enabled');
    const phoneticAlgorithmSelect = document.getElementById('fuzzy-phonetic-algorithm');
    const minLengthInput = document.getElementById('fuzzy-min-length');
    const maxComparisonsInput = document.getElementById('fuzzy-max-comparisons');
    const showConfidenceCheck = document.getElementById('fuzzy-show-confidence');
    const btnSave = document.getElementById('btn-save-fuzzy-settings');
    const btnReset = document.getElementById('btn-reset-fuzzy-settings');
    const messageDiv = document.getElementById('fuzzy-settings-message');

    // Update threshold value display
    thresholdInput.addEventListener('input', () => {
      thresholdValue.textContent = thresholdInput.value;
    });

    // Show/hide phonetic settings based on algorithm
    algorithmSelect.addEventListener('change', () => {
      if (algorithmSelect.value === 'phonetic') {
        phoneticSettings.style.display = 'block';
        phoneticEnabledCheck.checked = true;
      } else {
        phoneticSettings.style.display = 'none';
      }
    });

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings/fuzzy-matching');
        const data = await response.json();

        if (data.status === 'success' && data.settings) {
          const settings = data.settings;

          algorithmSelect.value = settings.algorithm;
          thresholdInput.value = Math.round(settings.threshold * 100);
          thresholdValue.textContent = Math.round(settings.threshold * 100);
          caseSensitiveCheck.checked = settings.case_sensitive;
          normalizeWhitespaceCheck.checked = settings.normalize_whitespace;
          stripPunctuationCheck.checked = settings.strip_punctuation;
          phoneticEnabledCheck.checked = settings.phonetic_enabled;
          phoneticAlgorithmSelect.value = settings.phonetic_algorithm;
          minLengthInput.value = settings.min_string_length;
          maxComparisonsInput.value = settings.max_comparisons;
          showConfidenceCheck.checked = settings.show_confidence_scores;

          // Update phonetic settings visibility
          if (settings.algorithm === 'phonetic') {
            phoneticSettings.style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Failed to load fuzzy matching settings:', err);
        messageDiv.textContent = 'Failed to load settings: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    async function saveSettings() {
      const settingsData = {
        algorithm: algorithmSelect.value,
        threshold: parseFloat(thresholdInput.value) / 100.0,
        case_sensitive: caseSensitiveCheck.checked,
        normalize_whitespace: normalizeWhitespaceCheck.checked,
        strip_punctuation: stripPunctuationCheck.checked,
        phonetic_enabled: phoneticEnabledCheck.checked,
        phonetic_algorithm: phoneticAlgorithmSelect.value,
        min_string_length: parseInt(minLengthInput.value),
        max_comparisons: parseInt(maxComparisonsInput.value),
        show_confidence_scores: showConfidenceCheck.checked
      };

      try {
        const response = await fetch('/api/settings/fuzzy-matching', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settingsData)
        });

        const data = await response.json();

        if (data.status === 'success') {
          messageDiv.textContent = 'Settings saved successfully!';
          messageDiv.style.color = 'green';
          setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        } else {
          messageDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
          messageDiv.style.color = 'red';
        }
      } catch (err) {
        messageDiv.textContent = 'Save failed: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    async function resetSettings() {
      if (!confirm('Reset to default fuzzy matching settings?')) {
        return;
      }

      // Reset to defaults
      const defaults = {
        algorithm: 'levenshtein',
        threshold: 0.80,
        case_sensitive: false,
        normalize_whitespace: true,
        strip_punctuation: true,
        phonetic_enabled: false,
        phonetic_algorithm: 'metaphone',
        min_string_length: 3,
        max_comparisons: 10000,
        show_confidence_scores: true
      };

      try {
        const response = await fetch('/api/settings/fuzzy-matching', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(defaults)
        });

        const data = await response.json();

        if (data.status === 'success') {
          await loadSettings(); // Reload to reflect changes
          messageDiv.textContent = 'Reset to defaults!';
          messageDiv.style.color = 'green';
          setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        }
      } catch (err) {
        messageDiv.textContent = 'Reset failed: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    if (btnSave) btnSave.addEventListener('click', saveSettings);
    if (btnReset) btnReset.addEventListener('click', resetSettings);

    // Load settings on page load
    loadSettings();
  }

  // Initialize fuzzy matching immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFuzzyMatching);
  } else {
    initFuzzyMatching();
  }

  // Chat / GraphRAG Settings
  function initChatSettings() {
    const llmProviderSelect = document.getElementById('chat-llm-provider');
    const verboseCheck = document.getElementById('chat-verbose-mode');
    const saveSettingsBtn = document.getElementById('chat-save-settings');
    const saveLLMConfigBtn = document.getElementById('chat-save-llm-config');

    // LLM provider settings panels
    const anthropicSettings = document.getElementById('anthropic-settings');
    const openaiSettings = document.getElementById('openai-settings');
    const ollamaSettings = document.getElementById('ollama-settings');

    if (!llmProviderSelect) return;

    // Handle LLM provider switching
    llmProviderSelect.addEventListener('change', () => {
      const provider = llmProviderSelect.value;

      // Hide all provider settings
      anthropicSettings.style.display = 'none';
      openaiSettings.style.display = 'none';
      ollamaSettings.style.display = 'none';

      // Show selected provider settings
      if (provider === 'anthropic') {
        anthropicSettings.style.display = 'block';
      } else if (provider === 'openai') {
        openaiSettings.style.display = 'block';
      } else if (provider === 'ollama') {
        ollamaSettings.style.display = 'block';
      }
    });

    // Show/hide API key toggles
    ['anthropic', 'openai'].forEach(provider => {
      const keyInput = document.getElementById(`chat-${provider}-key`);
      const keyShowCheck = document.getElementById(`chat-${provider}-key-show`);

      if (keyShowCheck && keyInput) {
        keyShowCheck.addEventListener('change', () => {
          keyInput.type = keyShowCheck.checked ? 'text' : 'password';
        });
      }
    });

    // Save LLM configuration
    saveLLMConfigBtn.addEventListener('click', async () => {
      const provider = llmProviderSelect.value;
      const config = {
        provider: provider,
        verbose: verboseCheck.checked
      };

      // Add provider-specific settings
      if (provider === 'anthropic') {
        config.anthropic_api_key = document.getElementById('chat-anthropic-key').value.trim();
        config.anthropic_model = document.getElementById('chat-anthropic-model').value;
      } else if (provider === 'openai') {
        config.openai_api_key = document.getElementById('chat-openai-key').value.trim();
        config.openai_model = document.getElementById('chat-openai-model').value;
      } else if (provider === 'ollama') {
        config.ollama_url = document.getElementById('chat-ollama-url').value.trim();
        config.ollama_model = document.getElementById('chat-ollama-model').value;
      }

      try {
        const resp = await fetch('/api/settings/chat/llm-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.status === 'success' || resp.ok) {
          toast('LLM configuration saved successfully', 'success');
        } else {
          toast('Failed to save configuration: ' + (data.error || 'unknown'), 'error');
        }
      } catch (err) {
        toast('Error saving configuration: ' + err.message, 'error');
      }
    });

    // Save chat settings
    if (saveSettingsBtn && verboseCheck) {
      saveSettingsBtn.addEventListener('click', async () => {
        try {
          const resp = await fetch('/api/settings/chat/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ verbose: verboseCheck.checked })
          });
          const data = await resp.json();
          if (data.status === 'success') {
            toast('Settings saved successfully', 'success');
          } else {
            toast('Failed to save settings: ' + (data.error || 'unknown'), 'error');
          }
        } catch (err) {
          toast('Error saving settings: ' + err.message, 'error');
        }
      });
    }

    // Load current settings
    async function loadChatSettings() {
      try {
        const resp = await fetch('/api/settings/chat/config');
        if (resp.ok) {
          const data = await resp.json();
          if (data.verbose !== undefined && verboseCheck) {
            verboseCheck.checked = data.verbose;
          }
        }
      } catch (err) {
        console.error('Failed to load chat settings:', err);
      }
    }

    loadChatSettings();
  }

  // Initialize chat settings immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChatSettings);
  } else {
    initChatSettings();
  }

  // Configuration Export (wireframe)
  function initConfigExport() {
    const btnExportConfig = document.getElementById('btn-export-config');
    const btnImportConfig = document.getElementById('btn-import-config');
    const btnViewBackups = document.getElementById('btn-view-backups');
    const configFileInput = document.getElementById('config-file-input');
    const configStatus = document.getElementById('config-status');

    // Export configuration
    if (btnExportConfig) {
      btnExportConfig.addEventListener('click', async () => {
        try {
          btnExportConfig.disabled = true;
          btnExportConfig.textContent = 'Exporting...';

          const resp = await fetch('/api/settings/export', {
            credentials: 'same-origin'
          });

          if (!resp.ok) {
            // Try to parse error as JSON
            const errorData = await resp.text();
            try {
              const json = JSON.parse(errorData);
              throw new Error(json.error || `Export failed (${resp.status})`);
            } catch {
              throw new Error(`Export failed (${resp.status})`);
            }
          }

          // Get the filename from Content-Disposition header or generate one
          const disposition = resp.headers.get('Content-Disposition');
          let filename = 'scidk-backup.zip';
          if (disposition && disposition.includes('filename=')) {
            filename = disposition.split('filename=')[1].replace(/["']/g, '');
          }

          // Download the zip file
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          configStatus.className = 'alert alert-success small';
          configStatus.textContent = `Backup created successfully: ${filename}`;
          configStatus.style.display = 'block';
          setTimeout(() => { configStatus.style.display = 'none'; }, 5000);
        } catch (err) {
          configStatus.className = 'alert alert-danger small';
          configStatus.textContent = `Export failed: ${err.message}`;
          configStatus.style.display = 'block';
        } finally {
          btnExportConfig.disabled = false;
          btnExportConfig.textContent = 'Export Configuration';
        }
      });
    }

    // Import configuration
    if (btnImportConfig && configFileInput) {
      btnImportConfig.addEventListener('click', () => {
        configFileInput.click();
      });

      configFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Confirm before restoring
        if (!confirm(`Restore from backup: ${file.name}?\n\nThis will:\n- Create a backup of current state\n- Replace all databases and settings\n- Require a page reload\n\nContinue?`)) {
          configFileInput.value = '';  // Reset file input
          return;
        }

        try {
          btnImportConfig.disabled = true;
          btnImportConfig.textContent = 'Restoring...';

          // Upload the backup zip file
          const formData = new FormData();
          formData.append('backup_file', file);

          const importResp = await fetch('/api/settings/import', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
          });

          const importData = await importResp.json();

          if (importData.status === 'success' && importData.report && importData.report.success) {
            configStatus.className = 'alert alert-success small';
            configStatus.textContent = `Backup restored successfully! ${importData.report.files_restored} files restored.`;
            if (importData.report.pre_restore_backup) {
              configStatus.textContent += ` Backup created: ${importData.report.pre_restore_backup.substring(0, 8)}`;
            }
            configStatus.style.display = 'block';

            // Suggest page reload
            setTimeout(() => {
              if (confirm('Backup restored. Reload page now?')) {
                location.reload();
              }
            }, 1000);
          } else {
            const error = (importData.report && importData.report.error) || importData.error || 'Unknown error';
            throw new Error(error);
          }
        } catch (err) {
          configStatus.className = 'alert alert-danger small';
          configStatus.textContent = `Import failed: ${err.message}`;
          configStatus.style.display = 'block';
        } finally {
          btnImportConfig.disabled = false;
          btnImportConfig.textContent = 'Import Configuration';
          configFileInput.value = ''; // Reset file input
        }
      });
    }

    // View backups
    if (btnViewBackups) {
      btnViewBackups.addEventListener('click', async () => {
        try {
          const resp = await fetch('/api/settings/backups?limit=10', {
            credentials: 'same-origin'
          });

          const data = await resp.json();

          if (!resp.ok) {
            throw new Error(data.error || `Failed to fetch backups (${resp.status})`);
          }

          if (data.status === 'success') {
            if (data.backups.length === 0) {
              alert('No backups found.');
              return;
            }

            // Show backups in a simple alert (could be improved with modal)
            let msg = 'Recent configuration backups:\n\n';
            data.backups.forEach((backup, idx) => {
              const date = new Date(backup.timestamp).toLocaleString();
              msg += `${idx + 1}. ${backup.filename} (${backup.size_human})\n`;
              msg += `   Date: ${date}\n`;
              msg += `   Reason: ${backup.reason} by ${backup.created_by}\n`;
              if (backup.notes) {
                msg += `   Notes: ${backup.notes}\n`;
              }
              if (backup.backup_id) {
                msg += `   ID: ${backup.backup_id.substring(0, 8)}...\n`;
              }
              msg += '\n';
            });

            alert(msg);
          } else {
            throw new Error(data.error || 'Failed to list backups');
          }
        } catch (err) {
          alert(`Failed to view backups: ${err.message}`);
        }
      });
    }
  }

  // Security Settings
  function initSecuritySettings() {
    const authEnabledCheck = document.getElementById('security-auth-enabled');
    const authSettingsDiv = document.getElementById('security-auth-settings');
    const usernameInput = document.getElementById('security-username');
    const passwordInput = document.getElementById('security-password');
    const passwordShowCheck = document.getElementById('security-password-show');
    const lockEnabledCheck = document.getElementById('security-lock-enabled');
    const lockTimeoutContainer = document.getElementById('security-lock-timeout-container');
    const saveSecurityBtn = document.getElementById('btn-save-security');
    const statusP = document.getElementById('security-status');

    if (!authEnabledCheck) return;

    // Load current auth config
    async function loadAuthConfig() {
      try {
        const response = await fetch('/api/settings/security/auth');
        if (response.ok) {
          const data = await response.json();
          if (data.status === 'success' && data.config) {
            authEnabledCheck.checked = data.config.enabled || false;
            usernameInput.value = data.config.username || '';
            authSettingsDiv.style.display = data.config.enabled ? 'block' : 'none';

            if (data.config.has_password) {
              passwordInput.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }
          }
        }
      } catch (error) {
        console.error('Failed to load auth config:', error);
      }
    }

    // Toggle auth settings visibility
    authEnabledCheck.addEventListener('change', () => {
      authSettingsDiv.style.display = authEnabledCheck.checked ? 'block' : 'none';
    });

    // Toggle password visibility
    if (passwordShowCheck && passwordInput) {
      passwordShowCheck.addEventListener('change', () => {
        passwordInput.type = passwordShowCheck.checked ? 'text' : 'password';
      });
    }

    // Toggle lock timeout input (not yet implemented - future task)
    if (lockEnabledCheck && lockTimeoutContainer) {
      lockEnabledCheck.addEventListener('change', () => {
        lockTimeoutContainer.style.display = lockEnabledCheck.checked ? 'block' : 'none';
      });
    }

    // Save security settings
    if (saveSecurityBtn) {
      saveSecurityBtn.addEventListener('click', async () => {
        const enabled = authEnabledCheck.checked;
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        // Validation
        if (enabled && !username) {
          toast('Username is required when enabling authentication', 'error');
          return;
        }

        // Password is required only if enabling for first time or changing it
        if (enabled && !password && passwordInput.placeholder !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
          toast('Password is required when enabling authentication', 'error');
          return;
        }

        // Disable button during save
        saveSecurityBtn.disabled = true;
        saveSecurityBtn.textContent = 'Saving...';
        statusP.textContent = '';

        try {
          const payload = { enabled, username };
          if (password) {
            payload.password = password;
          }

          const response = await fetch('/api/settings/security/auth', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          const data = await response.json();

          if (response.ok && data.status === 'success') {
            toast('Security settings saved successfully', 'success');
            statusP.textContent = enabled ?
              'âœ… Authentication is enabled. Users will need to log in to access SciDK.' :
              'Authentication is disabled. SciDK is accessible without login.';
            statusP.style.color = '#0a6';

            // Clear password field after successful save
            passwordInput.value = '';
            passwordInput.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';

            // If auth was enabled, redirect to login after a short delay
            if (enabled) {
              setTimeout(() => {
                window.location.href = '/login';
              }, 2000);
            }
          } else {
            toast(data.error || 'Failed to save security settings', 'error');
            statusP.textContent = 'âŒ ' + (data.error || 'Failed to save');
            statusP.style.color = '#b00';
          }
        } catch (error) {
          toast('Connection error. Please try again.', 'error');
          statusP.textContent = 'âŒ Connection error';
          statusP.style.color = '#b00';
        } finally {
          saveSecurityBtn.disabled = false;
          saveSecurityBtn.textContent = 'Save Security Settings';
        }
      });
    }

    // Load initial config
    loadAuthConfig();

    // Check if current user is admin and show user management/audit sections
    checkAdminAccess();
  }

  // User Management (Admin Only)
  async function checkAdminAccess() {
    try {
      const response = await fetch('/api/auth/status');
      if (response.ok) {
        const data = await response.json();

        const legacySetup = document.getElementById('security-legacy-setup');
        const userMessage = document.getElementById('security-user-message');
        const adminMessage = document.getElementById('security-admin-message');

        // Show current user info if authenticated
        if (data.authenticated && data.username) {
          const currentUserInfo = document.getElementById('current-user-info');
          const currentUsername = document.getElementById('current-username');
          const currentRoleBadge = document.getElementById('current-role-badge');

          if (currentUserInfo && currentUsername && currentRoleBadge) {
            currentUsername.textContent = data.username;
            currentRoleBadge.textContent = data.role || 'user';

            // Color code the role badge
            if (data.role === 'admin') {
              currentRoleBadge.style.background = '#ffc107';
              currentRoleBadge.style.color = '#000';
            } else {
              currentRoleBadge.style.background = '#6c757d';
              currentRoleBadge.style.color = '#fff';
            }

            currentUserInfo.style.display = 'block';
          }

          // Hide legacy setup form and show appropriate message
          if (legacySetup) legacySetup.style.display = 'none';

          if (data.role === 'admin') {
            // Show message for admin
            if (adminMessage) adminMessage.style.display = 'block';
            if (userMessage) userMessage.style.display = 'none';
          } else {
            // Show message for regular user
            if (userMessage) userMessage.style.display = 'block';
            if (adminMessage) adminMessage.style.display = 'none';
          }
        } else {
          // Not logged in - show legacy setup form if it exists
          if (legacySetup) legacySetup.style.display = 'block';
          if (userMessage) userMessage.style.display = 'none';
          if (adminMessage) adminMessage.style.display = 'none';
        }

        // Only show admin sections if user is admin
        if (data.authenticated && data.role === 'admin') {
          // Show admin-only sections
          const usersSection = document.getElementById('users-section-container');
          const auditSection = document.getElementById('audit-section-container');
          if (usersSection) usersSection.style.display = 'block';
          if (auditSection) auditSection.style.display = 'block';

          // Initialize user management and audit log
          initUserManagement();
          initAuditLog();
        }
      }
    } catch (error) {
      console.error('Failed to check admin access:', error);
    }
  }

  function initUserManagement() {
    const addUserBtn = document.getElementById('btn-add-user');
    const usersListContainer = document.getElementById('users-list-container');

    if (!usersListContainer) return;

    // Load users list
    async function loadUsers() {
      try {
        const response = await fetch('/api/users?include_disabled=true');
        if (response.ok) {
          const data = await response.json();
          renderUsersList(data.users || []);
        } else if (response.status === 403) {
          usersListContainer.innerHTML = '<p class="small" style="color:#b00">Access denied. Admin role required.</p>';
        } else {
          usersListContainer.innerHTML = '<p class="small" style="color:#b00">Failed to load users.</p>';
        }
      } catch (error) {
        console.error('Failed to load users:', error);
        usersListContainer.innerHTML = '<p class="small" style="color:#b00">Connection error.</p>';
      }
    }

    // Render users list
    function renderUsersList(users) {
      if (users.length === 0) {
        usersListContainer.innerHTML = '<p class="small" style="color:#666">No users found.</p>';
        return;
      }

      const table = document.createElement('table');
      table.style.cssText = 'width:100%; border-collapse:collapse';
      table.innerHTML = `
        <thead>
          <tr style="border-bottom:2px solid #ddd; text-align:left">
            <th style="padding:0.5rem; font-size:0.9em">Username</th>
            <th style="padding:0.5rem; font-size:0.9em">Role</th>
            <th style="padding:0.5rem; font-size:0.9em">Status</th>
            <th style="padding:0.5rem; font-size:0.9em">Last Login</th>
            <th style="padding:0.5rem; font-size:0.9em">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(user => `
            <tr style="border-bottom:1px solid #eee">
              <td style="padding:0.5rem; font-size:0.9em">${escapeHtml(user.username)}</td>
              <td style="padding:0.5rem; font-size:0.9em">
                <span class="badge" style="background:${user.role === 'admin' ? '#ffc107' : '#6c757d'}; color:${user.role === 'admin' ? '#000' : '#fff'}">${user.role}</span>
              </td>
              <td style="padding:0.5rem; font-size:0.9em">
                <span class="badge" style="background:${user.enabled ? '#28a745' : '#dc3545'}; color:#fff">${user.enabled ? 'Active' : 'Disabled'}</span>
              </td>
              <td style="padding:0.5rem; font-size:0.9em">${user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'Never'}</td>
              <td style="padding:0.5rem; font-size:0.9em">
                <button class="btn-edit-user" data-user-id="${user.id}" style="padding:0.25rem 0.5rem; border:1px solid #ccc; border-radius:3px; background:#fff; cursor:pointer; font-size:0.85em; margin-right:0.25rem">Edit</button>
                <button class="btn-delete-user" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}" style="padding:0.25rem 0.5rem; border:1px solid #dc3545; border-radius:3px; background:#fff; color:#dc3545; cursor:pointer; font-size:0.85em">Delete</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      `;

      usersListContainer.innerHTML = '';
      usersListContainer.appendChild(table);

      // Add event listeners for edit/delete buttons
      table.querySelectorAll('.btn-edit-user').forEach(btn => {
        btn.addEventListener('click', () => editUser(btn.dataset.userId));
      });

      table.querySelectorAll('.btn-delete-user').forEach(btn => {
        btn.addEventListener('click', () => deleteUser(btn.dataset.userId, btn.dataset.username));
      });
    }

    // Add user
    if (addUserBtn) {
      addUserBtn.addEventListener('click', () => {
        showAddUserDialog();
      });
    }

    // Show add user dialog
    function showAddUserDialog() {
      // Create modal dialog
      const dialog = document.createElement('div');
      dialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999';

      dialog.innerHTML = `
        <div style="background:#fff; border-radius:8px; padding:2rem; max-width:500px; width:90%">
          <h3 style="margin-top:0">Add New User</h3>

          <div style="margin-bottom:1rem">
            <label style="display:block; font-size:0.9em; margin-bottom:0.25rem; font-weight:500">Username</label>
            <input id="new-user-username" type="text" placeholder="username" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px" />
          </div>

          <div style="margin-bottom:1rem">
            <label style="display:block; font-size:0.9em; margin-bottom:0.25rem; font-weight:500">Password</label>
            <input id="new-user-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px" />
          </div>

          <div style="margin-bottom:1.5rem">
            <label style="display:block; font-size:0.9em; margin-bottom:0.5rem; font-weight:500">Role</label>
            <div style="display:flex; gap:1rem">
              <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem; border:1px solid #ddd; border-radius:4px; flex:1">
                <input type="radio" name="new-user-role" value="user" checked style="cursor:pointer" />
                <span style="flex:1">
                  <div style="font-weight:500">
                    <span class="badge" style="background:#6c757d; color:#fff">User</span>
                  </div>
                  <div style="font-size:0.8em; color:#666; margin-top:0.25rem">Regular access</div>
                </span>
              </label>
              <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem; border:1px solid #ddd; border-radius:4px; flex:1">
                <input type="radio" name="new-user-role" value="admin" style="cursor:pointer" />
                <span style="flex:1">
                  <div style="font-weight:500">
                    <span class="badge" style="background:#ffc107; color:#000">Admin</span>
                  </div>
                  <div style="font-size:0.8em; color:#666; margin-top:0.25rem">Full control</div>
                </span>
              </label>
            </div>
          </div>

          <div style="display:flex; gap:0.5rem; justify-content:flex-end">
            <button id="cancel-add-user" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer">Cancel</button>
            <button id="confirm-add-user" style="padding:0.5rem 1rem; border:none; border-radius:4px; background:#007bff; color:#fff; cursor:pointer">Add User</button>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // Focus username field
      const usernameInput = document.getElementById('new-user-username');
      setTimeout(() => usernameInput.focus(), 100);

      // Cancel button
      document.getElementById('cancel-add-user').addEventListener('click', () => {
        document.body.removeChild(dialog);
      });

      // Confirm button
      document.getElementById('confirm-add-user').addEventListener('click', () => {
        const username = document.getElementById('new-user-username').value.trim();
        const password = document.getElementById('new-user-password').value;
        const role = document.querySelector('input[name="new-user-role"]:checked').value;

        if (!username) {
          toast('Username is required', 'error');
          return;
        }

        if (!password) {
          toast('Password is required', 'error');
          return;
        }

        document.body.removeChild(dialog);
        createUser(username, password, role);
      });

      // Close on background click
      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
          document.body.removeChild(dialog);
        }
      });

      // Close on Escape key
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          document.body.removeChild(dialog);
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }

    async function createUser(username, password, role) {
      try {
        const response = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, role }),
        });

        const data = await response.json();

        if (response.ok) {
          toast(`User "${username}" created successfully`, 'success');
          loadUsers();
        } else {
          toast(data.error || 'Failed to create user', 'error');
        }
      } catch (error) {
        toast('Connection error', 'error');
      }
    }

    // Edit user
    async function editUser(userId) {
      // Simple implementation - just toggle enabled/disabled
      const action = confirm('Enable or disable this user?\n\nOK = Enable, Cancel = Disable');

      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: action }),
        });

        if (response.ok) {
          toast('User updated successfully', 'success');
          loadUsers();
        } else {
          const data = await response.json();
          toast(data.error || 'Failed to update user', 'error');
        }
      } catch (error) {
        toast('Connection error', 'error');
      }
    }

    // Delete user
    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          toast(`User "${username}" deleted successfully`, 'success');
          loadUsers();
        } else {
          const data = await response.json();
          toast(data.error || 'Failed to delete user', 'error');
        }
      } catch (error) {
        toast('Connection error', 'error');
      }
    }

    // Load initial users
    loadUsers();
  }

  // Audit Log (Admin Only)
  function initAuditLog() {
    const refreshBtn = document.getElementById('btn-refresh-audit');
    const auditLogContainer = document.getElementById('audit-log-container');

    if (!auditLogContainer) return;

    // Load audit log
    async function loadAuditLog() {
      try {
        const response = await fetch('/api/audit-log?limit=50');
        if (response.ok) {
          const data = await response.json();
          renderAuditLog(data.entries || []);
        } else if (response.status === 403) {
          auditLogContainer.innerHTML = '<p class="small" style="color:#b00">Access denied. Admin role required.</p>';
        } else {
          auditLogContainer.innerHTML = '<p class="small" style="color:#b00">Failed to load audit log.</p>';
        }
      } catch (error) {
        console.error('Failed to load audit log:', error);
        auditLogContainer.innerHTML = '<p class="small" style="color:#b00">Connection error.</p>';
      }
    }

    // Render audit log
    function renderAuditLog(entries) {
      if (entries.length === 0) {
        auditLogContainer.innerHTML = '<p class="small" style="color:#666">No audit entries found.</p>';
        return;
      }

      const table = document.createElement('table');
      table.style.cssText = 'width:100%; border-collapse:collapse';
      table.innerHTML = `
        <thead>
          <tr style="border-bottom:2px solid #ddd; text-align:left">
            <th style="padding:0.5rem; font-size:0.9em">Timestamp</th>
            <th style="padding:0.5rem; font-size:0.9em">User</th>
            <th style="padding:0.5rem; font-size:0.9em">Action</th>
            <th style="padding:0.5rem; font-size:0.9em">Details</th>
            <th style="padding:0.5rem; font-size:0.9em">IP Address</th>
          </tr>
        </thead>
        <tbody>
          ${entries.map(entry => `
            <tr style="border-bottom:1px solid #eee">
              <td style="padding:0.5rem; font-size:0.85em">${new Date(entry.timestamp * 1000).toLocaleString()}</td>
              <td style="padding:0.5rem; font-size:0.85em">${escapeHtml(entry.username)}</td>
              <td style="padding:0.5rem; font-size:0.85em">
                <code style="background:#f5f5f5; padding:0.1rem 0.3rem; border-radius:3px">${escapeHtml(entry.action)}</code>
              </td>
              <td style="padding:0.5rem; font-size:0.85em">${escapeHtml(entry.details || '')}</td>
              <td style="padding:0.5rem; font-size:0.85em">${escapeHtml(entry.ip_address || '')}</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      auditLogContainer.innerHTML = '';
      auditLogContainer.appendChild(table);
    }

    // Refresh button
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadAuditLog);
    }

    // Load initial audit log
    loadAuditLog();
  }

  // Helper function to escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize new General section features
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initConfigExport();
      initSecuritySettings();
    });
  } else {
    initConfigExport();
    initSecuritySettings();
  }
</script>
{% endblock %}
