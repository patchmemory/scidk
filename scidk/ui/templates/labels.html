{% extends 'base.html' %}
{% block title %}SciDK - Labels{% endblock %}
{% block content %}
<style>
  .labels-container {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    height: calc(100vh - 200px);
  }
  .labels-list {
    flex: 0 0 30%;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 0.5rem;
    overflow-y: auto;
  }
  .labels-editor {
    flex: 1;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 1rem;
    overflow-y: auto;
  }
  .label-item {
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid transparent;
  }
  .label-item:hover {
    background: #f3f3f3;
  }
  .label-item.active {
    background: #e3f2fd;
    border-color: #2196f3;
  }
  .property-row, .relationship-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    align-items: center;
  }
  .property-row input, .relationship-row input, .relationship-row select {
    flex: 1;
  }
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }
  .empty-state {
    text-align: center;
    color: #999;
    padding: 2rem;
  }
  /* Source label links in incoming relationships */
  .source-label-link:hover {
    text-decoration: underline !important;
    cursor: pointer;
  }
  /* Custom Modal */
  .custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
  }
  .custom-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }
  .custom-modal-content {
    position: relative;
    background: white;
    max-width: 700px;
    margin: 50px auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1001;
  }
  .custom-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eee;
  }
  .custom-modal-header h5 {
    margin: 0;
    font-size: 1.1rem;
  }
  .custom-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    line-height: 1;
    color: #666;
  }
  .custom-modal-close:hover {
    color: #000;
  }
  .custom-modal-body {
    padding: 1.5rem;
  }
  .custom-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
</style>

<h1>Labels</h1>
<p class="small">Define and manage graph schema labels with properties and relationships.</p>

<div class="labels-container">
  <!-- Left Panel: Label List -->
  <div class="labels-list">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <h3 class="small" style="margin: 0;">Labels</h3>
      <button id="btn-new-label" class="btn btn-sm btn-primary" data-testid="new-label-btn">New Label</button>
    </div>
    <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
      <button id="btn-import-arrows" class="btn btn-sm btn-outline-info" data-testid="import-arrows-btn" style="flex: 1; font-size: 0.75rem;">Import Arrows</button>
      <button id="btn-export-arrows" class="btn btn-sm btn-outline-info" data-testid="export-arrows-btn" style="flex: 1; font-size: 0.75rem;">Export Arrows</button>
    </div>
    <div id="label-list" data-testid="label-list">
      <div class="empty-state small">No labels defined</div>
    </div>
  </div>

  <!-- Right Panel: Label Editor -->
  <div class="labels-editor" id="label-editor" style="display: none;">
    <h3 id="editor-title">New Label</h3>

    <div style="margin-bottom: 1rem;">
      <label class="form-label small" for="label-name">Name</label>
      <input id="label-name" type="text" class="form-control form-control-sm" placeholder="e.g., Project" data-testid="label-name" />
      <div id="name-error" class="small" style="color: #b00020; display: none;"></div>
    </div>

    <div class="section-header">
      <h4 class="small" style="margin: 0;">Properties</h4>
      <button id="btn-add-property" class="btn btn-sm btn-outline-primary" data-testid="add-property-btn">Add Property</button>
    </div>
    <div id="properties-container" data-testid="properties-container">
      <div class="empty-state small">No properties defined</div>
    </div>

    <div class="section-header">
      <h4 class="small" style="margin: 0;">Outgoing Relationships</h4>
      <button id="btn-add-relationship" class="btn btn-sm btn-outline-primary" data-testid="add-relationship-btn">Add Relationship</button>
    </div>
    <div id="relationships-container" data-testid="relationships-container">
      <div class="empty-state small">No relationships defined</div>
    </div>

    <div class="section-header" style="margin-top: 1.5rem;">
      <h4 class="small" style="margin: 0;">Incoming Relationships</h4>
    </div>
    <div id="incoming-relationships-container" data-testid="incoming-relationships-container">
      <div class="empty-state small">No incoming relationships</div>
    </div>

    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <button id="btn-save" class="btn btn-sm btn-success" data-testid="save-label-btn">Save</button>
      <button id="btn-delete" class="btn btn-sm btn-outline-danger" data-testid="delete-label-btn" style="display: none;">Delete</button>
      <button id="btn-push-neo4j" class="btn btn-sm btn-outline-primary" data-testid="push-neo4j-btn" style="display: none;">Push to Neo4j</button>
      <button id="btn-pull-neo4j" class="btn btn-sm btn-outline-secondary" data-testid="pull-neo4j-btn">Pull from Neo4j</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="import-arrows-modal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h5>Import Schema from Arrows.app</h5>
      <button type="button" class="custom-modal-close" onclick="closeImportModal()">&times;</button>
    </div>
    <div class="custom-modal-body">
      <p class="small">Paste JSON exported from <a href="https://arrows.app" target="_blank" rel="noopener">arrows.app</a></p>
      <textarea id="arrows-json-input" class="form-control font-monospace" rows="12" placeholder='{"nodes": [...], "relationships": [...]}'></textarea>
      <div style="margin-top: 0.5rem;">
        <label for="arrows-file-input" class="btn btn-sm btn-outline-secondary">
          Or choose file...
        </label>
        <input type="file" id="arrows-file-input" accept=".json" style="display:none">
        <span id="file-name" class="small" style="margin-left: 0.5rem;"></span>
      </div>
      <div id="import-preview" style="display:none; margin-top: 1rem; padding: 0.75rem; background: #f9f9f9; border-radius: 4px;">
        <div class="small"><strong>Preview:</strong> <span id="preview-label-count">0</span> labels, <span id="preview-rel-count">0</span> relationships</div>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeImportModal()">Cancel</button>
      <button type="button" id="import-confirm-btn" class="btn btn-sm btn-success" data-testid="import-confirm-btn" onclick="importFromArrows()">Import</button>
    </div>
  </div>
</div>

<script>
let currentLabel = null;
let labels = [];

// Toast function
function showToast(message, type = 'info') {
  if (typeof window.toast === 'function') {
    window.toast(message, type, 3000);
  } else {
    console.log(`[${type}] ${message}`);
  }
}

// Modal functions
function openImportModal() {
  document.getElementById('import-arrows-modal').style.display = 'block';
}

function closeImportModal() {
  const modal = document.getElementById('import-arrows-modal');
  modal.style.display = 'none';
  // Clear input
  document.getElementById('arrows-json-input').value = '';
  document.getElementById('file-name').textContent = '';
  document.getElementById('import-preview').style.display = 'none';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadLabels();

  document.getElementById('btn-new-label').addEventListener('click', () => {
    currentLabel = null;
    showEditor();
    clearEditor();
    document.getElementById('editor-title').textContent = 'New Label';
    document.getElementById('btn-delete').style.display = 'none';
    document.getElementById('btn-push-neo4j').style.display = 'none';
  });

  document.getElementById('btn-save').addEventListener('click', saveLabel);
  document.getElementById('btn-delete').addEventListener('click', deleteLabel);
  document.getElementById('btn-push-neo4j').addEventListener('click', pushToNeo4j);
  document.getElementById('btn-pull-neo4j').addEventListener('click', pullFromNeo4j);
  document.getElementById('btn-add-property').addEventListener('click', addProperty);
  document.getElementById('btn-add-relationship').addEventListener('click', addRelationship);

  // Arrows.app Import/Export
  document.getElementById('btn-import-arrows')?.addEventListener('click', openImportModal);
  document.getElementById('btn-export-arrows')?.addEventListener('click', exportToArrows);

  document.getElementById('arrows-file-input')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('arrows-json-input').value = ev.target.result;
        document.getElementById('file-name').textContent = file.name;
        previewArrowsImport();
      };
      reader.readAsText(file);
    }
  });

  document.getElementById('arrows-json-input')?.addEventListener('input', previewArrowsImport);

  document.getElementById('import-confirm-btn')?.addEventListener('click', importFromArrows);
});

function loadLabels() {
  console.log('loadLabels() executing, fetching /api/labels');
  fetch('/api/labels')
    .then(r => {
      console.log('loadLabels() got response');
      return r.json();
    })
    .then(data => {
      console.log('loadLabels() got data:', data);
      if (data.status === 'success') {
        labels = data.labels || [];
        renderLabelList();
      } else {
        showToast('Error loading labels: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => {
      console.error('loadLabels() error:', err);
      showToast('Network error: ' + err.message, 'error');
    });
}

function renderLabelList() {
  const container = document.getElementById('label-list');
  if (labels.length === 0) {
    container.innerHTML = '<div class="empty-state small">No labels defined</div>';
    return;
  }

  // Compute incoming relationship counts for each label
  const incomingCounts = {};
  labels.forEach(label => {
    incomingCounts[label.name] = 0;
  });
  labels.forEach(label => {
    (label.relationships || []).forEach(rel => {
      if (rel.target_label && incomingCounts[rel.target_label] !== undefined) {
        incomingCounts[rel.target_label]++;
      }
    });
  });

  container.innerHTML = labels.map(label => {
    const outgoing = label.relationships.length;
    const incoming = incomingCounts[label.name] || 0;
    const total = outgoing + incoming;
    const relText = total === 1 ? '1 relationship' : `${total} relationships`;
    const detailText = incoming > 0 ? ` (${outgoing} out, ${incoming} in)` : '';

    return `
      <div class="label-item ${currentLabel && currentLabel.name === label.name ? 'active' : ''}"
           data-label="${label.name}"
           data-testid="label-item">
        <strong>${label.name}</strong>
        <div class="small">${label.properties.length} properties, ${relText}${detailText}</div>
      </div>
    `;
  }).join('');

  // Add click handlers
  container.querySelectorAll('.label-item').forEach(item => {
    item.addEventListener('click', () => {
      const labelName = item.dataset.label;
      loadLabel(labelName);
    });
  });
}

function loadLabel(name) {
  fetch(`/api/labels/${name}`)
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        currentLabel = data.label;
        showEditor();
        populateEditor(currentLabel);
        renderLabelList(); // Update active state
      } else {
        showToast('Error loading label: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => showToast('Network error: ' + err.message, 'error'));
}

function showEditor() {
  document.getElementById('label-editor').style.display = 'block';
}

function clearEditor() {
  document.getElementById('label-name').value = '';
  document.getElementById('label-name').readOnly = false;
  document.getElementById('properties-container').innerHTML = '<div class="empty-state small">No properties defined</div>';
  document.getElementById('relationships-container').innerHTML = '<div class="empty-state small">No relationships defined</div>';
  document.getElementById('incoming-relationships-container').innerHTML = '<div class="empty-state small">No incoming relationships</div>';
  document.getElementById('name-error').style.display = 'none';
}

function populateEditor(label) {
  document.getElementById('editor-title').textContent = `Edit Label: ${label.name}`;
  document.getElementById('label-name').value = label.name;
  document.getElementById('label-name').readOnly = true;
  document.getElementById('btn-delete').style.display = 'inline-block';
  document.getElementById('btn-push-neo4j').style.display = 'inline-block';

  // Render properties
  const propsContainer = document.getElementById('properties-container');
  if (label.properties.length === 0) {
    propsContainer.innerHTML = '<div class="empty-state small">No properties defined</div>';
  } else {
    propsContainer.innerHTML = label.properties.map((prop, i) => createPropertyRow(prop, i)).join('');
  }

  // Render outgoing relationships
  const relsContainer = document.getElementById('relationships-container');
  if (label.relationships.length === 0) {
    relsContainer.innerHTML = '<div class="empty-state small">No relationships defined</div>';
  } else {
    relsContainer.innerHTML = label.relationships.map((rel, i) => createRelationshipRow(rel, i)).join('');
  }

  // Render incoming relationships (read-only with clickable source labels)
  const incomingContainer = document.getElementById('incoming-relationships-container');
  const incomingRels = label.incoming_relationships || [];
  if (incomingRels.length === 0) {
    incomingContainer.innerHTML = '<div class="empty-state small">No incoming relationships</div>';
  } else {
    incomingContainer.innerHTML = incomingRels.map(rel =>
      `<div class="relationship-row" style="background: #f9f9f9; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;">
        <span class="small">
          <a href="#" class="source-label-link" data-label="${rel.source_label}" style="color: var(--accent); text-decoration: none; font-weight: bold;">
            ${rel.source_label}
          </a> → [${rel.type}] → <em>this label</em>
        </span>
      </div>`
    ).join('');

    // Add click handlers for source label links
    incomingContainer.querySelectorAll('.source-label-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sourceLabelName = link.dataset.label;
        loadLabel(sourceLabelName);
      });
    });
  }
}

function addProperty() {
  const container = document.getElementById('properties-container');
  if (container.querySelector('.empty-state')) {
    container.innerHTML = '';
  }
  container.insertAdjacentHTML('beforeend', createPropertyRow({name: '', type: 'string', required: false}));
}

function createPropertyRow(prop, index) {
  return `
    <div class="property-row" data-index="${index || ''}" data-testid="property-row">
      <input type="text" class="form-control form-control-sm" placeholder="Property name"
             value="${prop.name || ''}" data-field="name" data-testid="property-name" />
      <select class="form-select form-select-sm" data-field="type" data-testid="property-type">
        <option value="string" ${prop.type === 'string' ? 'selected' : ''}>string</option>
        <option value="number" ${prop.type === 'number' ? 'selected' : ''}>number</option>
        <option value="boolean" ${prop.type === 'boolean' ? 'selected' : ''}>boolean</option>
        <option value="date" ${prop.type === 'date' ? 'selected' : ''}>date</option>
        <option value="datetime" ${prop.type === 'datetime' ? 'selected' : ''}>datetime</option>
      </select>
      <div class="form-check" style="flex: 0 0 auto; display: flex; align-items: center;">
        <input type="checkbox" class="form-check-input" ${prop.required ? 'checked' : ''}
               data-field="required" data-testid="property-required" />
        <label class="form-check-label small" style="margin-left: 0.25rem;">Required</label>
      </div>
      <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()" data-testid="remove-property-btn">×</button>
    </div>
  `;
}

function addRelationship() {
  const container = document.getElementById('relationships-container');
  if (container.querySelector('.empty-state')) {
    container.innerHTML = '';
  }
  container.insertAdjacentHTML('beforeend', createRelationshipRow({type: '', target_label: '', properties: []}));
}

function createRelationshipRow(rel, index) {
  const labelOptions = labels.map(l =>
    `<option value="${l.name}" ${rel.target_label === l.name ? 'selected' : ''}>${l.name}</option>`
  ).join('\n        ');
  return `
    <div class="relationship-row" data-index="${index || ''}" data-testid="relationship-row">
      <input type="text" class="form-control form-control-sm" placeholder="Type (e.g., HAS_FILE)"
             value="${rel.type || ''}" data-field="type" data-testid="relationship-type" />
      <select class="form-select form-select-sm" data-field="target_label" data-testid="relationship-target">
        <option value="">-- Select target label --</option>
        ${labelOptions}
      </select>
      <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()" data-testid="remove-relationship-btn">×</button>
    </div>
  `;
}

function saveLabel() {
  const name = document.getElementById('label-name').value.trim();
  if (!name) {
    document.getElementById('name-error').textContent = 'Label name is required';
    document.getElementById('name-error').style.display = 'block';
    return;
  }
  document.getElementById('name-error').style.display = 'none';

  // Gather properties
  const properties = Array.from(document.querySelectorAll('.property-row')).map(row => ({
    name: row.querySelector('[data-field="name"]').value.trim(),
    type: row.querySelector('[data-field="type"]').value,
    required: row.querySelector('[data-field="required"]').checked
  })).filter(p => p.name);

  // Gather relationships
  const relationships = Array.from(document.querySelectorAll('.relationship-row')).map(row => ({
    type: row.querySelector('[data-field="type"]').value.trim(),
    target_label: row.querySelector('[data-field="target_label"]').value,
    properties: []
  })).filter(r => r.type && r.target_label);

  const payload = { name, properties, relationships };

  fetch('/api/labels', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        showToast('Label saved successfully', 'success');
        currentLabel = data.label;
        loadLabels();
        populateEditor(currentLabel);
      } else {
        showToast('Error saving label: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => showToast('Network error: ' + err.message, 'error'));
}

function deleteLabel() {
  if (!currentLabel) return;

  if (!confirm(`Delete label "${currentLabel.name}"?`)) return;

  fetch(`/api/labels/${currentLabel.name}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        showToast('Label deleted successfully', 'success');
        currentLabel = null;
        document.getElementById('label-editor').style.display = 'none';
        loadLabels();
      } else {
        showToast('Error deleting label: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => showToast('Network error: ' + err.message, 'error'));
}

function pushToNeo4j() {
  if (!currentLabel) return;

  showToast('Pushing to Neo4j...', 'info');

  fetch(`/api/labels/${currentLabel.name}/push`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        const msg = `Pushed to Neo4j. Constraints: ${data.constraints_created.length}`;
        showToast(msg, 'success');
      } else {
        showToast('Error pushing to Neo4j: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => showToast('Network error: ' + err.message, 'error'));
}

function pullFromNeo4j() {
  if (!confirm('Pull schema from Neo4j? This will import labels and may overwrite local definitions.')) return;

  showToast('Pulling from Neo4j...', 'info');

  fetch('/api/labels/pull', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        showToast(`Imported ${data.count} labels from Neo4j`, 'success');
        loadLabels();
      } else {
        showToast('Error pulling from Neo4j: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => showToast('Network error: ' + err.message, 'error'));
}

function previewArrowsImport() {
  const input = document.getElementById('arrows-json-input').value.trim();
  if (!input) {
    document.getElementById('import-preview').style.display = 'none';
    return;
  }

  try {
    const arrowsJson = JSON.parse(input);
    const nodeCount = arrowsJson.nodes?.length || 0;
    const relCount = arrowsJson.relationships?.length || 0;

    document.getElementById('preview-label-count').textContent = nodeCount;
    document.getElementById('preview-rel-count').textContent = relCount;
    document.getElementById('import-preview').style.display = 'block';
  } catch (e) {
    document.getElementById('import-preview').style.display = 'none';
  }
}

async function importFromArrows() {
  const input = document.getElementById('arrows-json-input').value.trim();
  if (!input) {
    showToast('Please paste Arrows.app JSON', 'warning');
    return;
  }

  try {
    const arrowsJson = JSON.parse(input);
    showToast('Importing schema...', 'info');

    const resp = await fetch('/api/labels/import/arrows', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({arrows_json: arrowsJson, mode: 'merge'})
    });

    const result = await resp.json();
    console.log('Import result:', result);

    if (result.status === 'success') {
      const msg = `Imported ${result.imported.labels} labels, ${result.imported.relationships} relationships`;
      showToast(msg, 'success');

      // Close modal
      closeImportModal();

      // Reload labels
      loadLabels();
    } else {
      showToast('Import failed: ' + result.error, 'error');
    }
  } catch (e) {
    console.error('Import error:', e);
    showToast('Import error: ' + e.message, 'error');
  }
}

async function exportToArrows() {
  try {
    showToast('Exporting schema...', 'info');
    window.location = '/api/labels/export/arrows';
    setTimeout(() => showToast('Schema exported successfully', 'success'), 500);
  } catch (e) {
    showToast('Export error: ' + e.message, 'error');
  }
}
</script>
{% endblock %}
